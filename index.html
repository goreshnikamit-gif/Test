<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InvoiceBox â€” ×¡×•×¨×§ ×—×©×‘×•× ×™×•×ª Gmail</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --bg2: #111827;
    --bg3: #1a2235;
    --card: #141d2e;
    --border: #1e2d45;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --accent4: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --muted: #64748b;
    --font: 'Rubik', sans-serif;
    --mono: 'JetBrains Mono', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .glow {
    position: fixed;
    width: 600px;
    height: 600px;
    border-radius: 50%;
    filter: blur(120px);
    pointer-events: none;
    z-index: 0;
  }
  .glow-1 { top: -200px; right: -100px; background: rgba(0,212,255,0.08); }
  .glow-2 { bottom: -200px; left: -100px; background: rgba(124,58,237,0.08); }

  /* ====== AUTH SCREEN ====== */
  #auth-screen {
    position: relative;
    z-index: 10;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 32px;
    padding: 40px 20px;
  }

  .logo {
    text-align: center;
  }
  .logo-icon {
    width: 80px;
    height: 80px;
    border-radius: 20px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin-bottom: 16px;
    box-shadow: 0 0 40px rgba(0,212,255,0.3);
  }
  .logo h1 {
    font-size: 36px;
    font-weight: 900;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -1px;
  }
  .logo p {
    color: var(--muted);
    font-size: 15px;
    margin-top: 8px;
  }

  .auth-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 40px;
    max-width: 480px;
    width: 100%;
    text-align: center;
  }

  .auth-card h2 {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 12px;
  }

  .auth-card p {
    color: var(--muted);
    font-size: 14px;
    line-height: 1.7;
    margin-bottom: 28px;
  }

  .setup-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
    text-align: right;
  }
  .setup-field label {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
  }
  .setup-field input {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }
  .setup-field input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
  }
  .setup-field small {
    color: var(--muted);
    font-size: 11px;
    line-height: 1.5;
  }

  .btn-primary {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 12px;
    color: white;
    font-family: var(--font);
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,212,255,0.4); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .how-link {
    display: block;
    margin-top: 16px;
    color: var(--muted);
    font-size: 13px;
    cursor: pointer;
    text-decoration: underline;
  }
  .how-link:hover { color: var(--accent); }

  .how-box {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-top: 16px;
    text-align: right;
    display: none;
  }
  .how-box.open { display: block; }
  .how-box ol {
    padding-right: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .how-box li {
    font-size: 13px;
    color: var(--muted);
    line-height: 1.6;
  }
  .how-box li a { color: var(--accent); }

  /* ====== LOADING SCREEN ====== */
  #loading-screen {
    position: fixed; inset: 0; z-index: 100;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 24px;
  }

  .scan-animation {
    width: 120px;
    height: 120px;
    position: relative;
  }
  .scan-animation::before {
    content: 'ğŸ“§';
    font-size: 48px;
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
  }
  .scan-ring {
    position: absolute;
    inset: 0;
    border: 2px solid transparent;
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  .scan-ring:nth-child(2) {
    inset: 10px;
    border-top-color: var(--accent2);
    animation-duration: 1.4s;
    animation-direction: reverse;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  #loading-screen h2 {
    font-size: 22px;
    font-weight: 700;
  }
  #scan-status {
    color: var(--muted);
    font-size: 14px;
    font-family: var(--mono);
  }
  .progress-bar {
    width: 320px;
    height: 4px;
    background: var(--bg3);
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 4px;
    transition: width 0.3s;
    width: 0%;
  }

  /* ====== DASHBOARD ====== */
  #dashboard {
    position: relative;
    z-index: 10;
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px 20px;
  }

  .dash-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .dash-title {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .dash-title .logo-icon { width: 44px; height: 44px; font-size: 20px; margin: 0; border-radius: 12px; }
  .dash-title h1 { font-size: 24px; font-weight: 900; }
  .dash-title span { color: var(--muted); font-size: 13px; }

  .dash-actions {
    display: flex;
    gap: 10px;
  }

  .btn-sm {
    padding: 10px 18px;
    border-radius: 10px;
    font-family: var(--font);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .btn-ghost {
    background: var(--bg3);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  .btn-accent {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
  }
  .btn-accent:hover { opacity: 0.9; transform: translateY(-1px); }

  /* ====== STATS GRID ====== */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, border-color 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); border-color: var(--accent); }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .stat-card.blue::before { background: var(--accent); }
  .stat-card.purple::before { background: var(--accent2); }
  .stat-card.green::before { background: var(--accent3); }
  .stat-card.yellow::before { background: var(--accent4); }
  .stat-card.red::before { background: var(--danger); }

  .stat-label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 500;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .stat-value {
    font-size: 28px;
    font-weight: 800;
    font-family: var(--mono);
    letter-spacing: -1px;
  }
  .stat-card.blue .stat-value { color: var(--accent); }
  .stat-card.purple .stat-value { color: var(--accent2); }
  .stat-card.green .stat-value { color: var(--accent3); }
  .stat-card.yellow .stat-value { color: var(--accent4); }
  .stat-card.red .stat-value { color: var(--danger); }
  .stat-sub {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* ====== CHARTS ====== */
  .charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  @media(max-width: 900px) {
    .charts-grid { grid-template-columns: 1fr; }
  }

  .chart-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
  }

  .chart-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chart-title span { font-size: 18px; }

  /* ====== FILTERS ====== */
  .filters-row {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-input {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--text);
    font-family: var(--font);
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }
  .filter-input:focus { border-color: var(--accent); }
  .filter-input option { background: var(--bg2); }

  /* ====== TABLE ====== */
  .table-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 24px;
  }

  .table-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }

  .table-scroll { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead th {
    padding: 12px 16px;
    text-align: right;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    background: var(--bg3);
    white-space: nowrap;
    cursor: pointer;
  }
  thead th:hover { color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  tbody tr:hover { background: rgba(0,212,255,0.03); }
  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 14px 16px;
    font-size: 13px;
    white-space: nowrap;
  }

  .td-sender {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .avatar {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
  }
  .badge-green { background: rgba(16,185,129,0.15); color: var(--accent3); }
  .badge-blue { background: rgba(0,212,255,0.15); color: var(--accent); }
  .badge-yellow { background: rgba(245,158,11,0.15); color: var(--accent4); }
  .badge-red { background: rgba(239,68,68,0.15); color: var(--danger); }
  .badge-purple { background: rgba(124,58,237,0.15); color: var(--accent2); }

  .amount-cell {
    font-family: var(--mono);
    font-weight: 700;
  }

  .pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    font-size: 13px;
    color: var(--muted);
  }
  .page-btns {
    display: flex;
    gap: 6px;
  }
  .page-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg3);
    color: var(--text);
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }
  .page-btn:hover, .page-btn.active { border-color: var(--accent); color: var(--accent); }

  /* ====== TOP VENDORS ====== */
  .vendor-bar {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .vendor-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .vendor-info {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
  }
  .vendor-name { font-weight: 600; }
  .vendor-amount { font-family: var(--mono); color: var(--accent); font-weight: 700; }
  .vendor-track {
    height: 6px;
    background: var(--bg3);
    border-radius: 4px;
    overflow: hidden;
  }
  .vendor-fill {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width 1s ease;
  }

  /* ====== TOASTS ====== */
  .toast-container {
    position: fixed;
    bottom: 24px;
    left: 24px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .toast {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease;
    max-width: 320px;
  }
  @keyframes slideIn {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  .toast.success { border-color: var(--accent3); }
  .toast.error { border-color: var(--danger); }

  .hidden { display: none !important; }

  /* Monthly summary strip */
  .month-strip {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
    margin-bottom: 24px;
    scrollbar-width: thin;
  }
  .month-chip {
    flex-shrink: 0;
    padding: 8px 14px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
    background: var(--bg3);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    min-width: 80px;
  }
  .month-chip:hover, .month-chip.active {
    border-color: var(--accent);
    background: rgba(0,212,255,0.08);
    color: var(--accent);
  }
  .month-chip .chip-month { display: block; }
  .month-chip .chip-amount { display: block; font-family: var(--mono); font-size: 11px; color: var(--muted); margin-top: 2px; }
</style>
</head>
<body>

<div class="glow glow-1"></div>
<div class="glow glow-2"></div>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="logo">
    <div class="logo-icon">ğŸ“¬</div>
    <h1>InvoiceBox</h1>
    <p>×¡×•×¨×§ ×—×©×‘×•× ×™×•×ª ×—×›× ×œ×’'×™××™×™×œ ×©×œ×š</p>
  </div>

  <div class="auth-card">
    <h2>ğŸ”‘ ×—×™×‘×•×¨ ×œ×’×•×’×œ</h2>
    <p>×”×–×Ÿ ××ª ×”-Client ID ×©×œ×š ×-Google Cloud Console ×›×“×™ ×œ×—×‘×¨ ××ª ×”×’'×™××™×™×œ ×©×œ×š ×•×œ×¡×¨×•×§ ×—×©×‘×•× ×™×•×ª ××•×˜×•××˜×™×ª.</p>

    <div class="setup-field">
      <label>Google OAuth Client ID</label>
      <input type="text" id="client-id-input" placeholder="XXXXXXXXXX-xxxx.apps.googleusercontent.com" />
      <small>×ª××¦× ××ª ×–×” ×‘: console.cloud.google.com â†’ Credentials â†’ OAuth 2.0 Client IDs</small>
    </div>

    <div class="setup-field">
      <label>×˜×•×•×— ×¡×¨×™×§×” (×—×•×“×©×™× ××—×•×¨×”)</label>
      <input type="number" id="months-back" value="24" min="1" max="120" />
      <small>×›××” ×—×•×“×©×™× ××—×•×¨×” ×œ×¡×¨×•×§? (×‘×¨×™×¨×ª ××—×“×œ: 24 ×—×•×“×©×™×)</small>
    </div>

    <button class="btn-primary" onclick="startAuth()">
      ğŸš€ ×”×ª×—×‘×¨ ×•×¡×¨×•×§ ×—×©×‘×•× ×™×•×ª
    </button>

    <span class="how-link" onclick="toggleHow()">â“ ××™×š ××§×‘×œ×™× Client ID?</span>
    <div class="how-box" id="how-box">
      <ol>
        <li>×”×™×›× ×¡ ×œ-<a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a> ×•×¦×•×¨ ×¤×¨×•×™×§×˜ ×—×“×©</li>
        <li>×œ×š ×œ-"APIs & Services" â†’ "Enable APIs" â†’ ×”×¤×¢×œ ××ª <strong>Gmail API</strong></li>
        <li>×œ×š ×œ-"Credentials" â†’ "Create Credentials" â†’ "OAuth 2.0 Client ID"</li>
        <li>×‘×—×¨ "Web Application" ×•×”×•×¡×£ Authorized JS Origins: <code>file://</code> ×•-<code>http://localhost</code></li>
        <li>×”×¢×ª×§ ××ª ×”-Client ID ×•×”×“×‘×§ ×œ××¢×œ×”</li>
        <li>×œ×š ×œ-"OAuth Consent Screen" â†’ ×”×•×¡×£ ××ª ×”×’'×™××™×™×œ ×©×œ×š ×›-Test User</li>
      </ol>
    </div>
  </div>

  <!-- DEMO MODE -->
  <div class="auth-card" style="max-width:480px">
    <h2>ğŸ® ××¦×‘ ×“××•</h2>
    <p>×¨×•×¦×” ×œ×¨××•×ª ××™×š ×–×” × ×¨××” ×‘×œ×™ ×œ×”×ª×—×‘×¨? ×œ×—×¥ ×›××Ÿ ×œ×“××• ×¢× × ×ª×•× ×™× ××“×•××™×.</p>
    <button class="btn-primary" style="background: linear-gradient(135deg, var(--accent3), #059669);" onclick="loadDemo()">
      ğŸ‘ï¸ ×”×¦×’ ×“××•
    </button>
  </div>
</div>

<!-- LOADING SCREEN -->
<div id="loading-screen" class="hidden">
  <div class="scan-animation">
    <div class="scan-ring"></div>
    <div class="scan-ring"></div>
  </div>
  <h2>×¡×•×¨×§ ×—×©×‘×•× ×™×•×ª...</h2>
  <div id="scan-status">××ª×—×‘×¨ ×œ×’'×™××™×™×œ...</div>
  <div class="progress-bar">
    <div class="progress-fill" id="progress-fill"></div>
  </div>
  <div id="scan-count" style="color:var(--muted);font-size:12px;font-family:var(--mono)">0 ××™×™×œ×™× × ×¡×¨×§×•</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

  <div class="dash-header">
    <div class="dash-title">
      <div class="logo-icon">ğŸ“¬</div>
      <div>
        <h1>InvoiceBox</h1>
        <span id="user-email">××—×•×‘×¨</span>
      </div>
    </div>
    <div class="dash-actions">
      <button class="btn-sm btn-ghost" onclick="refreshScan()">ğŸ”„ ×¡×¨×•×§ ××—×“×©</button>
      <button class="btn-sm btn-ghost" onclick="exportCSV()">ğŸ“¥ ×™×™×¦×•× CSV</button>
      <button class="btn-sm btn-ghost" onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-grid" id="stats-grid">
    <!-- filled by JS -->
  </div>

  <!-- MONTH STRIP -->
  <div class="month-strip" id="month-strip"></div>

  <!-- CHARTS -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title"><span>ğŸ“ˆ</span> ×”×•×¦××•×ª ×œ×¤×™ ×—×•×“×©</div>
      <canvas id="monthly-chart" height="200"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-title"><span>ğŸ·ï¸</span> ×œ×¤×™ ×§×˜×’×•×¨×™×”</div>
      <canvas id="category-chart" height="200"></canvas>
    </div>
  </div>

  <!-- CHARTS ROW 2 -->
  <div class="charts-grid" style="grid-template-columns: 1fr 1fr; margin-bottom:24px">
    <div class="chart-card">
      <div class="chart-title"><span>ğŸª</span> ×¡×¤×§×™× ××•×‘×™×œ×™×</div>
      <div class="vendor-bar" id="vendor-bars"></div>
    </div>
    <div class="chart-card">
      <div class="chart-title"><span>ğŸ“Š</span> ××’××ª ×”×•×¦××•×ª</div>
      <canvas id="trend-chart" height="200"></canvas>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-card">
    <div class="table-header">
      <div class="chart-title" style="margin:0"><span>ğŸ§¾</span> ×›×œ ×”×—×©×‘×•× ×™×•×ª</div>
      <div class="filters-row" style="margin:0">
        <input type="text" class="filter-input" id="search-input" placeholder="ğŸ” ×—×¤×©..." onkeyup="filterTable()" style="width:180px">
        <select class="filter-input" id="category-filter" onchange="filterTable()">
          <option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
        </select>
        <select class="filter-input" id="sort-select" onchange="filterTable()">
          <option value="date-desc">×ª××¨×™×š â†“</option>
          <option value="date-asc">×ª××¨×™×š â†‘</option>
          <option value="amount-desc">×¡×›×•× â†“</option>
          <option value="amount-asc">×¡×›×•× â†‘</option>
          <option value="sender">×©×•×œ×—</option>
        </select>
      </div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('sender')">×©×•×œ×— â–¾</th>
            <th onclick="sortBy('subject')">× ×•×©× â–¾</th>
            <th onclick="sortBy('amount')">×¡×›×•× â–¾</th>
            <th onclick="sortBy('category')">×§×˜×’×•×¨×™×” â–¾</th>
            <th onclick="sortBy('date')">×ª××¨×™×š â–¾</th>
            <th>×¤×¢×•×œ×•×ª</th>
          </tr>
        </thead>
        <tbody id="invoice-tbody"></tbody>
      </table>
    </div>
    <div class="pagination">
      <span id="page-info">××¦×™×’ 1-20 ××ª×•×š 0</span>
      <div class="page-btns" id="page-btns"></div>
    </div>
  </div>

</div>

<!-- TOASTS -->
<div class="toast-container" id="toast-container"></div>

<script>
// ========================
// CONFIG
// ========================
const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest';

// Invoice detection patterns
const INVOICE_KEYWORDS = [
  'invoice', 'receipt', '×—×©×‘×•× ×™×ª', '×§×‘×œ×”', 'order confirmation', 'your order',
  'payment confirmation', '×”×–×× ×”', '××™×©×•×¨ ×ª×©×œ×•×', 'payment receipt',
  'billing', '×—×™×•×‘', '×ª×©×œ×•×', 'subscription', '×× ×•×™', 'purchase',
  'transaction', '×¢×¡×§×”', 'paid', '×©×•×œ×', 'thank you for your payment',
  '×ª×•×“×” ×¢×œ ×¨×›×™×©×ª×š', 'order #', '×”×–×× ×” ××¡×¤×¨', '××¡×¤×¨ ×”×–×× ×”',
  'bill', '×—×©×‘×•×Ÿ', 'statement'
];

// Category mapping
const CATEGORIES = {
  '×××–×•×Ÿ|amazon': { name: '×§× ×™×•×ª ××•× ×œ×™×™×Ÿ', icon: 'ğŸ›’', color: '#f59e0b' },
  'aliexpress|ebay': { name: '×§× ×™×•×ª ××•× ×œ×™×™×Ÿ', icon: 'ğŸ›’', color: '#f59e0b' },
  'netflix|spotify|apple|google play|youtube': { name: '×× ×•×™×™× ×“×™×’×™×˜×œ×™×™×', icon: 'ğŸ“±', color: '#7c3aed' },
  'wolt|10bis|deliveroo|uber eats': { name: '××•×›×œ ×•××©×œ×•×—×™×', icon: 'ğŸ•', color: '#ef4444' },
  'cellcom|hot|partner|bezeq|yes|012': { name: '×ª×§×©×•×¨×ª', icon: 'ğŸ“¡', color: '#00d4ff' },
  'electric|electricity|×—×©××œ|××™×|××¨× ×•× ×”': { name: '×—×©×‘×•× ×•×ª ×‘×™×ª', icon: 'ğŸ ', color: '#10b981' },
  'flights|booking|airbnb|hotel|×˜×™×¡×•×ª': { name: '× ×¡×™×¢×•×ª', icon: 'âœˆï¸', color: '#06b6d4' },
  'pharmacy|super pharm|×‘×™×ª ××¨×§×—×ª': { name: '×‘×¨×™××•×ª', icon: 'ğŸ’Š', color: '#84cc16' },
  'microsoft|adobe|dropbox|zoom': { name: '×ª×•×›× ×”', icon: 'ğŸ’»', color: '#6366f1' },
  'insurance|×‘×™×˜×•×—': { name: '×‘×™×˜×•×—', icon: 'ğŸ›¡ï¸', color: '#f97316' },
  'bank|×‘× ×§|visa|mastercard': { name: '×‘× ×§××•×ª', icon: 'ğŸ¦', color: '#eab308' },
  'fuel|×“×œ×§|sonol|paz|delek': { name: '×“×œ×§ ×•×¨×›×‘', icon: 'â›½', color: '#78716c' },
};

// Amount extraction patterns  
const AMOUNT_PATTERNS = [
  /â‚ª\s*([\d,]+(?:\.\d{1,2})?)/g,
  /ILS\s*([\d,]+(?:\.\d{1,2})?)/gi,
  /\$\s*([\d,]+(?:\.\d{1,2})?)/g,
  /â‚¬\s*([\d,]+(?:\.\d{1,2})?)/g,
  /([\d,]+(?:\.\d{1,2})?)\s*â‚ª/g,
  /([\d,]+(?:\.\d{1,2})?)\s*ILS/gi,
  /total[:\s]+[\$â‚ªâ‚¬]?\s*([\d,]+(?:\.\d{1,2})?)/gi,
  /×¡×”"×›[:\s]+([\d,]+(?:\.\d{1,2})?)/g,
  /×¡×›×•×[:\s]+([\d,]+(?:\.\d{1,2})?)/g,
  /amount[:\s]+[\$â‚ªâ‚¬]?\s*([\d,]+(?:\.\d{1,2})?)/gi,
];

// App state
let invoices = [];
let filteredInvoices = [];
let currentPage = 1;
const PAGE_SIZE = 20;
let monthlyChart, categoryChart, trendChart;
let activeMonth = null;
let gapiLoaded = false;

// ========================
// GOOGLE API
// ========================
function loadGAPI() {
  return new Promise((resolve) => {
    const s = document.createElement('script');
    s.src = 'https://apis.google.com/js/api.js';
    s.onload = () => {
      gapi.load('client', resolve);
    };
    document.head.appendChild(s);
  });
}

function loadGIS() {
  return new Promise((resolve) => {
    const s = document.createElement('script');
    s.src = 'https://accounts.google.com/gsi/client';
    s.onload = resolve;
    document.head.appendChild(s);
  });
}

async function startAuth() {
  const clientId = document.getElementById('client-id-input').value.trim();
  if (!clientId) {
    showToast('error', 'âŒ ×”×–×Ÿ Client ID ×ª×—×™×œ×”');
    return;
  }

  showScreen('loading');
  setStatus('×˜×•×¢×Ÿ Google API...');

  try {
    await loadGAPI();
    await loadGIS();

    await gapi.client.init({
      discoveryDocs: [DISCOVERY_DOC],
    });

    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: SCOPES,
      callback: async (response) => {
        if (response.error) {
          showScreen('auth');
          showToast('error', 'âŒ ×©×’×™××ª ××™××•×ª: ' + response.error);
          return;
        }
        await scanEmails();
      }
    });

    tokenClient.requestAccessToken();

  } catch (e) {
    showScreen('auth');
    showToast('error', 'âŒ ×©×’×™××”: ' + e.message);
  }
}

async function scanEmails() {
  setStatus('××—×¤×© ×—×©×‘×•× ×™×•×ª...');
  
  const monthsBack = parseInt(document.getElementById('months-back').value) || 24;
  const afterDate = new Date();
  afterDate.setMonth(afterDate.getMonth() - monthsBack);
  const afterTimestamp = Math.floor(afterDate.getTime() / 1000);

  const queries = [
    `after:${afterTimestamp} subject:(invoice OR receipt OR ×—×©×‘×•× ×™×ª OR ×§×‘×œ×” OR "order confirmation" OR "payment confirmation" OR ××™×©×•×¨ ×—×™×•×‘ OR billing)`,
    `after:${afterTimestamp} (invoice OR receipt) has:attachment`,
    `after:${afterTimestamp} from:(noreply OR billing OR payments OR invoices OR receipts)`,
  ];

  let allMessageIds = new Set();

  for (const q of queries) {
    try {
      let pageToken = null;
      do {
        const params = { userId: 'me', q, maxResults: 500 };
        if (pageToken) params.pageToken = pageToken;
        const res = await gapi.client.gmail.users.messages.list(params);
        const msgs = res.result.messages || [];
        msgs.forEach(m => allMessageIds.add(m.id));
        pageToken = res.result.nextPageToken;
        setStatus(`× ××¦××• ${allMessageIds.size} ×”×•×“×¢×•×ª ×¤×•×˜× ×¦×™××œ×™×•×ª...`);
      } while (pageToken && allMessageIds.size < 2000);
    } catch(e) {}
  }

  const ids = [...allMessageIds];
  const total = ids.length;
  invoices = [];

  setStatus(`×¡×•×¨×§ ${total} ×”×•×“×¢×•×ª...`);

  // Batch fetch (25 at a time)
  const BATCH = 25;
  for (let i = 0; i < ids.length; i += BATCH) {
    const batch = ids.slice(i, i + BATCH);
    const promises = batch.map(id =>
      gapi.client.gmail.users.messages.get({
        userId: 'me',
        id,
        format: 'metadata',
        metadataHeaders: ['From', 'Subject', 'Date'],
      }).then(r => r.result).catch(() => null)
    );

    const results = await Promise.all(promises);
    results.forEach(msg => {
      if (!msg) return;
      const inv = parseMessage(msg);
      if (inv) invoices.push(inv);
    });

    const pct = Math.round(((i + BATCH) / total) * 100);
    document.getElementById('progress-fill').style.width = pct + '%';
    document.getElementById('scan-count').textContent = `${Math.min(i + BATCH, total)} / ${total} ××™×™×œ×™× × ×¡×¨×§×• | ${invoices.length} ×—×©×‘×•× ×™×•×ª × ××¦××•`;

    await new Promise(r => setTimeout(r, 50));
  }

  // Get user email
  try {
    const profile = await gapi.client.gmail.users.getProfile({ userId: 'me' });
    document.getElementById('user-email').textContent = profile.result.emailAddress;
  } catch(e) {}

  buildDashboard();
  showScreen('dashboard');
  showToast('success', `âœ… × ××¦××• ${invoices.length} ×—×©×‘×•× ×™×•×ª!`);
}

function parseMessage(msg) {
  const headers = {};
  (msg.payload?.headers || []).forEach(h => { headers[h.name.toLowerCase()] = h.value; });

  const subject = headers['subject'] || '';
  const from = headers['from'] || '';
  const dateStr = headers['date'] || '';

  // Check if looks like invoice
  const combined = (subject + ' ' + from).toLowerCase();
  const isInvoice = INVOICE_KEYWORDS.some(kw => combined.includes(kw.toLowerCase()));
  if (!isInvoice) return null;

  // Parse date
  let date = new Date(dateStr);
  if (isNaN(date)) date = new Date();

  // Extract sender name
  const senderMatch = from.match(/^"?([^"<]+)"?\s*</);
  const senderName = senderMatch ? senderMatch[1].trim() : from.split('@')[0] || from;

  // Extract amount from subject
  let amount = null;
  for (const pattern of AMOUNT_PATTERNS) {
    pattern.lastIndex = 0;
    const m = pattern.exec(subject);
    if (m) {
      const val = parseFloat(m[1].replace(/,/g, ''));
      if (val > 0 && val < 1000000) { amount = val; break; }
    }
  }

  // Categorize
  const category = categorize(combined);

  return {
    id: msg.id,
    sender: senderName,
    from: from,
    subject: subject,
    date: date,
    amount: amount,
    category: category.name,
    categoryIcon: category.icon,
    categoryColor: category.color,
  };
}

function categorize(text) {
  for (const [pattern, cat] of Object.entries(CATEGORIES)) {
    const patterns = pattern.split('|');
    if (patterns.some(p => text.includes(p))) return cat;
  }
  return { name: '××—×¨', icon: 'ğŸ“„', color: '#64748b' };
}

// ========================
// DEMO
// ========================
function loadDemo() {
  showScreen('loading');
  setStatus('×˜×•×¢×Ÿ × ×ª×•× ×™ ×“××•...');

  const vendors = [
    { name: 'Amazon', cat: '×§× ×™×•×ª ××•× ×œ×™×™×Ÿ', icon: 'ğŸ›’', color: '#f59e0b' },
    { name: 'Netflix', cat: '×× ×•×™×™× ×“×™×’×™×˜×œ×™×™×', icon: 'ğŸ“±', color: '#7c3aed' },
    { name: 'Spotify', cat: '×× ×•×™×™× ×“×™×’×™×˜×œ×™×™×', icon: 'ğŸ“±', color: '#7c3aed' },
    { name: 'Wolt', cat: '××•×›×œ ×•××©×œ×•×—×™×', icon: 'ğŸ•', color: '#ef4444' },
    { name: 'Partner Mobile', cat: '×ª×§×©×•×¨×ª', icon: 'ğŸ“¡', color: '#00d4ff' },
    { name: 'Hot', cat: '×ª×§×©×•×¨×ª', icon: 'ğŸ“¡', color: '#00d4ff' },
    { name: 'Apple', cat: '×× ×•×™×™× ×“×™×’×™×˜×œ×™×™×', icon: 'ğŸ“±', color: '#7c3aed' },
    { name: 'Ali Express', cat: '×§× ×™×•×ª ××•× ×œ×™×™×Ÿ', icon: 'ğŸ›’', color: '#f59e0b' },
    { name: 'Adobe', cat: '×ª×•×›× ×”', icon: 'ğŸ’»', color: '#6366f1' },
    { name: 'Microsoft', cat: '×ª×•×›× ×”', icon: 'ğŸ’»', color: '#6366f1' },
    { name: 'Booking.com', cat: '× ×¡×™×¢×•×ª', icon: 'âœˆï¸', color: '#06b6d4' },
    { name: 'Super-Pharm', cat: '×‘×¨×™××•×ª', icon: 'ğŸ’Š', color: '#84cc16' },
    { name: 'Electric Co.', cat: '×—×©×‘×•× ×•×ª ×‘×™×ª', icon: 'ğŸ ', color: '#10b981' },
    { name: 'Google', cat: '×× ×•×™×™× ×“×™×’×™×˜×œ×™×™×', icon: 'ğŸ“±', color: '#7c3aed' },
    { name: 'Dropbox', cat: '×ª×•×›× ×”', icon: 'ğŸ’»', color: '#6366f1' },
  ];

  invoices = [];
  const now = new Date();

  for (let m = 23; m >= 0; m--) {
    const numInvoices = Math.floor(Math.random() * 20) + 8;
    for (let i = 0; i < numInvoices; i++) {
      const v = vendors[Math.floor(Math.random() * vendors.length)];
      const d = new Date(now.getFullYear(), now.getMonth() - m, Math.floor(Math.random() * 28) + 1);
      const amount = Math.round((Math.random() * 300 + 10) * 10) / 10;
      invoices.push({
        id: `demo-${m}-${i}`,
        sender: v.name,
        from: `billing@${v.name.toLowerCase().replace(/\s/g,'')}.com`,
        subject: `Invoice #${Math.floor(Math.random()*90000+10000)} - â‚ª${amount}`,
        date: d,
        amount: amount,
        category: v.cat,
        categoryIcon: v.icon,
        categoryColor: v.color,
      });
    }
  }

  let p = 0;
  const interval = setInterval(() => {
    p += 5;
    document.getElementById('progress-fill').style.width = p + '%';
    document.getElementById('scan-count').textContent = `${Math.floor(p/100*invoices.length)} / ${invoices.length} ×—×©×‘×•× ×™×•×ª × ×¡×¨×§×•`;
    if (p >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        document.getElementById('user-email').textContent = 'demo@gmail.com (×“××•)';
        buildDashboard();
        showScreen('dashboard');
        showToast('success', `âœ… ×“××•: ${invoices.length} ×—×©×‘×•× ×™×•×ª ×“××”!`);
      }, 300);
    }
  }, 40);
}

// ========================
// DASHBOARD
// ========================
function buildDashboard() {
  invoices.sort((a,b) => b.date - a.date);
  filteredInvoices = [...invoices];

  buildStats();
  buildMonthStrip();
  buildCharts();
  buildVendorBars();
  buildTable();
  buildCategoryFilter();
}

function buildStats() {
  const withAmount = invoices.filter(i => i.amount);
  const totalAmount = withAmount.reduce((s, i) => s + i.amount, 0);
  const avgAmount = withAmount.length ? totalAmount / withAmount.length : 0;
  
  const now = new Date();
  const thisMonth = invoices.filter(i =>
    i.date.getMonth() === now.getMonth() && i.date.getFullYear() === now.getFullYear()
  );
  const thisMonthAmount = thisMonth.filter(i=>i.amount).reduce((s,i)=>s+i.amount,0);

  const cats = {};
  invoices.forEach(i => { cats[i.category] = (cats[i.category]||0)+1; });
  const topCat = Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];

  document.getElementById('stats-grid').innerHTML = `
    <div class="stat-card blue">
      <div class="stat-label">×¡×”"×› ×—×©×‘×•× ×™×•×ª</div>
      <div class="stat-value">${invoices.length}</div>
      <div class="stat-sub">×‘-${getMonthsRange()} ×—×•×“×©×™×</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">×¡×”"×› ×”×•×¦××•×ª</div>
      <div class="stat-value">â‚ª${formatNum(totalAmount)}</div>
      <div class="stat-sub">${withAmount.length} ×¢× ×¡×›×•×</div>
    </div>
    <div class="stat-card yellow">
      <div class="stat-label">×××•×¦×¢ ×œ×—×©×‘×•× ×™×ª</div>
      <div class="stat-value">â‚ª${formatNum(avgAmount)}</div>
      <div class="stat-sub">××‘×•×¡×¡ ${withAmount.length} ×—×©×‘×•× ×™×•×ª</div>
    </div>
    <div class="stat-card purple">
      <div class="stat-label">×”×—×•×“×©</div>
      <div class="stat-value">â‚ª${formatNum(thisMonthAmount)}</div>
      <div class="stat-sub">${thisMonth.length} ×—×©×‘×•× ×™×•×ª</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">×§×˜×’×•×¨×™×” ××•×‘×™×œ×”</div>
      <div class="stat-value" style="font-size:18px">${topCat ? topCat[0] : '-'}</div>
      <div class="stat-sub">${topCat ? topCat[1] + ' ×—×©×‘×•× ×™×•×ª' : ''}</div>
    </div>
  `;
}

function getMonthsRange() {
  if (!invoices.length) return 0;
  const oldest = invoices.reduce((a,b) => a.date < b.date ? a : b);
  const months = Math.ceil((new Date() - oldest.date) / (30*24*3600*1000));
  return months;
}

function buildMonthStrip() {
  const monthly = {};
  invoices.forEach(i => {
    const key = `${i.date.getFullYear()}-${String(i.date.getMonth()+1).padStart(2,'0')}`;
    if (!monthly[key]) monthly[key] = { count: 0, amount: 0 };
    monthly[key].count++;
    if (i.amount) monthly[key].amount += i.amount;
  });

  const sorted = Object.entries(monthly).sort((a,b) => b[0].localeCompare(a[0]));
  const strip = document.getElementById('month-strip');
  strip.innerHTML = `<div class="month-chip active" onclick="filterMonth(null, this)">
    <span class="chip-month">×”×›×œ</span>
    <span class="chip-amount">${invoices.length} ×—×©×‘×•× ×™×•×ª</span>
  </div>`;

  sorted.forEach(([key, data]) => {
    const [y, m] = key.split('-');
    const monthNames = ['×™× ×•','×¤×‘×¨','××¨×¥','××¤×¨','×××™','×™×•× ×™','×™×•×œ×™','××•×’','×¡×¤×˜','××•×§','× ×•×‘','×“×¦×'];
    strip.innerHTML += `
      <div class="month-chip" onclick="filterMonth('${key}', this)">
        <span class="chip-month">${monthNames[parseInt(m)-1]} ${y}</span>
        <span class="chip-amount">â‚ª${formatNum(data.amount)}</span>
      </div>`;
  });
}

function filterMonth(key, el) {
  document.querySelectorAll('.month-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  activeMonth = key;

  if (!key) {
    filteredInvoices = [...invoices];
  } else {
    const [y, m] = key.split('-');
    filteredInvoices = invoices.filter(i =>
      i.date.getFullYear() === parseInt(y) && (i.date.getMonth()+1) === parseInt(m)
    );
  }

  applyFilters();
}

function buildCharts() {
  // Monthly data
  const monthly = {};
  invoices.forEach(i => {
    const key = `${i.date.getFullYear()}-${String(i.date.getMonth()+1).padStart(2,'0')}`;
    if (!monthly[key]) monthly[key] = 0;
    if (i.amount) monthly[key] += i.amount;
  });

  const sorted = Object.entries(monthly).sort((a,b) => a[0].localeCompare(b[0]));
  const monthNames = ['×™× ×•','×¤×‘×¨','××¨×¥','××¤×¨','×××™','×™×•× ×™','×™×•×œ×™','××•×’','×¡×¤×˜','××•×§','× ×•×‘','×“×¦×'];
  const labels = sorted.map(([k]) => {
    const [y,m] = k.split('-');
    return `${monthNames[parseInt(m)-1]} ${y.slice(2)}`;
  });
  const amounts = sorted.map(([,v]) => Math.round(v));

  const chartDefaults = {
    responsive: true,
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { color: '#1e2d45' }, ticks: { color: '#64748b', font: { size: 10, family: "'Rubik'" } } },
      y: { grid: { color: '#1e2d45' }, ticks: { color: '#64748b', font: { size: 10, family: "'Rubik'" }, callback: v => 'â‚ª'+formatNum(v) } },
    }
  };

  if (monthlyChart) monthlyChart.destroy();
  monthlyChart = new Chart(document.getElementById('monthly-chart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: amounts,
        backgroundColor: amounts.map((_,i) => `rgba(0,212,255,${0.3+0.7*(i/amounts.length)})`),
        borderColor: 'rgba(0,212,255,0.8)',
        borderWidth: 1,
        borderRadius: 6,
      }]
    },
    options: chartDefaults,
  });

  // Category donut
  const catTotals = {};
  invoices.forEach(i => {
    if (i.amount) {
      catTotals[i.category] = (catTotals[i.category]||0) + i.amount;
    }
  });
  const catColors = {
    '×§× ×™×•×ª ××•× ×œ×™×™×Ÿ':'#f59e0b','×× ×•×™×™× ×“×™×’×™×˜×œ×™×™×':'#7c3aed','××•×›×œ ×•××©×œ×•×—×™×':'#ef4444',
    '×ª×§×©×•×¨×ª':'#00d4ff','×—×©×‘×•× ×•×ª ×‘×™×ª':'#10b981','× ×¡×™×¢×•×ª':'#06b6d4','×‘×¨×™××•×ª':'#84cc16',
    '×ª×•×›× ×”':'#6366f1','×‘×™×˜×•×—':'#f97316','×‘× ×§××•×ª':'#eab308','×“×œ×§ ×•×¨×›×‘':'#78716c','××—×¨':'#64748b'
  };
  const catEntries = Object.entries(catTotals).sort((a,b)=>b[1]-a[1]);

  if (categoryChart) categoryChart.destroy();
  categoryChart = new Chart(document.getElementById('category-chart'), {
    type: 'doughnut',
    data: {
      labels: catEntries.map(([k])=>k),
      datasets: [{
        data: catEntries.map(([,v])=>Math.round(v)),
        backgroundColor: catEntries.map(([k])=>catColors[k]||'#64748b'),
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#94a3b8', font: { size: 11, family: "'Rubik'" }, padding: 10, boxWidth: 12 }
        },
        tooltip: {
          callbacks: { label: (c) => ` â‚ª${formatNum(c.raw)}` }
        }
      }
    }
  });

  // Trend chart
  const ma3 = amounts.map((v,i) => {
    const window = amounts.slice(Math.max(0,i-2), i+1);
    return Math.round(window.reduce((a,b)=>a+b,0)/window.length);
  });

  if (trendChart) trendChart.destroy();
  trendChart = new Chart(document.getElementById('trend-chart'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: '×”×•×¦××•×ª',
          data: amounts,
          borderColor: 'rgba(0,212,255,0.5)',
          backgroundColor: 'rgba(0,212,255,0.05)',
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointBackgroundColor: '#00d4ff',
        },
        {
          label: '×××•×¦×¢ × ×¢',
          data: ma3,
          borderColor: 'rgba(124,58,237,0.8)',
          backgroundColor: 'transparent',
          borderDash: [4,4],
          tension: 0.4,
          pointRadius: 0,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { size: 11, family: "'Rubik'" } } }
      },
      scales: {
        x: { grid: { color: '#1e2d45' }, ticks: { color: '#64748b', font: { size: 10 } } },
        y: { grid: { color: '#1e2d45' }, ticks: { color: '#64748b', font: { size: 10 }, callback: v => 'â‚ª'+formatNum(v) } },
      }
    }
  });
}

function buildVendorBars() {
  const vendors = {};
  invoices.forEach(i => {
    if (i.amount) vendors[i.sender] = (vendors[i.sender]||0) + i.amount;
  });

  const top = Object.entries(vendors).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const max = top[0]?.[1] || 1;
  const colors = ['#00d4ff','#7c3aed','#10b981','#f59e0b','#ef4444','#6366f1','#84cc16','#f97316'];

  document.getElementById('vendor-bars').innerHTML = top.map(([name, amount], i) => `
    <div class="vendor-row">
      <div class="vendor-info">
        <span class="vendor-name">${name}</span>
        <span class="vendor-amount">â‚ª${formatNum(amount)}</span>
      </div>
      <div class="vendor-track">
        <div class="vendor-fill" style="width:${(amount/max*100).toFixed(1)}%;background:${colors[i%colors.length]}"></div>
      </div>
    </div>
  `).join('');
}

function buildCategoryFilter() {
  const cats = [...new Set(invoices.map(i=>i.category))].sort();
  const sel = document.getElementById('category-filter');
  sel.innerHTML = '<option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>' +
    cats.map(c => `<option value="${c}">${c}</option>`).join('');
}

function buildTable() {
  const start = (currentPage-1)*PAGE_SIZE;
  const page = filteredInvoices.slice(start, start+PAGE_SIZE);

  const colors = ['#00d4ff','#7c3aed','#10b981','#f59e0b','#ef4444','#6366f1','#f97316','#84cc16'];
  const avatarColor = (name) => colors[name.charCodeAt(0) % colors.length];

  document.getElementById('invoice-tbody').innerHTML = page.map(inv => `
    <tr>
      <td>
        <div class="td-sender">
          <div class="avatar" style="background:${avatarColor(inv.sender)}22;color:${avatarColor(inv.sender)}">
            ${inv.categoryIcon || inv.sender[0].toUpperCase()}
          </div>
          <div>
            <div style="font-weight:600;font-size:13px">${esc(inv.sender)}</div>
            <div style="color:var(--muted);font-size:11px">${esc(inv.from.replace(/<.*>/,'').trim()).substring(0,40)}</div>
          </div>
        </div>
      </td>
      <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis">${esc(inv.subject).substring(0,60)}${inv.subject.length>60?'...':''}</td>
      <td class="amount-cell" style="color:${inv.amount ? 'var(--accent3)' : 'var(--muted)'}">
        ${inv.amount ? 'â‚ª'+formatNum(inv.amount) : 'â€”'}
      </td>
      <td>
        <span class="badge" style="background:${inv.categoryColor}22;color:${inv.categoryColor}">
          ${inv.categoryIcon} ${inv.category}
        </span>
      </td>
      <td style="color:var(--muted)">${formatDate(inv.date)}</td>
      <td>
        <button class="btn-sm btn-ghost" style="padding:6px 10px;font-size:11px"
          onclick="openEmail('${inv.id}')">ğŸ“§ ×¤×ª×—</button>
      </td>
    </tr>
  `).join('');

  // Pagination
  document.getElementById('page-info').textContent =
    `××¦×™×’ ${start+1}-${Math.min(start+PAGE_SIZE, filteredInvoices.length)} ××ª×•×š ${filteredInvoices.length}`;

  const totalPages = Math.ceil(filteredInvoices.length/PAGE_SIZE);
  let pagesHTML = '';
  const showPages = [];
  for (let p = Math.max(1,currentPage-2); p <= Math.min(totalPages,currentPage+2); p++) showPages.push(p);
  if (!showPages.includes(1)) { pagesHTML += `<button class="page-btn" onclick="goPage(1)">1</button>`; if (showPages[0]>2) pagesHTML += `<span style="color:var(--muted);padding:0 4px">...</span>`; }
  showPages.forEach(p => {
    pagesHTML += `<button class="page-btn${p===currentPage?' active':''}" onclick="goPage(${p})">${p}</button>`;
  });
  if (!showPages.includes(totalPages) && totalPages > 1) { if (showPages[showPages.length-1]<totalPages-1) pagesHTML += `<span style="color:var(--muted);padding:0 4px">...</span>`; pagesHTML += `<button class="page-btn" onclick="goPage(${totalPages})">${totalPages}</button>`; }
  document.getElementById('page-btns').innerHTML = pagesHTML;
}

function goPage(p) { currentPage = p; buildTable(); window.scrollTo(0,0); }

function filterTable() {
  applyFilters();
}

function applyFilters() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const cat = document.getElementById('category-filter').value;
  const sort = document.getElementById('sort-select').value;

  let base = activeMonth
    ? invoices.filter(i => {
        const [y,m] = activeMonth.split('-');
        return i.date.getFullYear()===parseInt(y) && (i.date.getMonth()+1)===parseInt(m);
      })
    : [...invoices];

  filteredInvoices = base.filter(i => {
    const matchSearch = !search ||
      i.sender.toLowerCase().includes(search) ||
      i.subject.toLowerCase().includes(search) ||
      i.category.toLowerCase().includes(search);
    const matchCat = !cat || i.category === cat;
    return matchSearch && matchCat;
  });

  filteredInvoices.sort((a,b) => {
    if (sort==='date-desc') return b.date-a.date;
    if (sort==='date-asc') return a.date-b.date;
    if (sort==='amount-desc') return (b.amount||0)-(a.amount||0);
    if (sort==='amount-asc') return (a.amount||0)-(b.amount||0);
    if (sort==='sender') return a.sender.localeCompare(b.sender);
    return 0;
  });

  currentPage = 1;
  buildTable();
}

function sortBy(field) {
  const sel = document.getElementById('sort-select');
  if (field==='date') sel.value = sel.value==='date-desc'?'date-asc':'date-desc';
  else if (field==='amount') sel.value = sel.value==='amount-desc'?'amount-asc':'amount-desc';
  else if (field==='sender') sel.value = 'sender';
  filterTable();
}

function openEmail(id) {
  window.open(`https://mail.google.com/mail/u/0/#inbox/${id}`, '_blank');
}

function exportCSV() {
  const rows = [['×©×•×œ×—','× ×•×©×','×¡×›×•×','×§×˜×’×•×¨×™×”','×ª××¨×™×š']];
  filteredInvoices.forEach(i => {
    rows.push([i.sender, i.subject, i.amount||'', i.category, formatDate(i.date)]);
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([''+csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `invoices_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showToast('success', 'ğŸ“¥ CSV ×™×•×¦× ×‘×”×¦×œ×—×”!');
}

function refreshScan() {
  invoices = [];
  showScreen('loading');
  document.getElementById('progress-fill').style.width = '0%';
  scanEmails();
}

function logout() {
  invoices = [];
  showScreen('auth');
}

// ========================
// HELPERS
// ========================
function showScreen(name) {
  document.getElementById('auth-screen').classList.toggle('hidden', name!=='auth');
  document.getElementById('loading-screen').classList.toggle('hidden', name!=='loading');
  document.getElementById('dashboard').classList.toggle('hidden', name!=='dashboard');
}

function setStatus(msg) {
  document.getElementById('scan-status').textContent = msg;
}

function formatNum(n) {
  if (!n && n!==0) return '0';
  return Math.round(n).toLocaleString('he-IL');
}

function formatDate(d) {
  if (!d || isNaN(d)) return '';
  return d.toLocaleDateString('he-IL', { day:'2-digit', month:'2-digit', year:'2-digit' });
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(type, msg) {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

function toggleHow() {
  document.getElementById('how-box').classList.toggle('open');
}
</script>
</body>
</html>
