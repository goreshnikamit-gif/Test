<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InvoiceBox Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #070b14;
  --surface:  #0d1525;
  --card:     #111c30;
  --card2:    #162035;
  --border:   #1d2e4a;
  --border2:  #243758;
  --c1:       #00e5ff;
  --c2:       #6c47ff;
  --c3:       #00ffa3;
  --c4:       #ff6b35;
  --c5:       #ffd93d;
  --c6:       #ff4d6d;
  --text:     #e8f0fe;
  --text2:    #8ba3c7;
  --text3:    #4a6080;
  --font:     'Heebo', sans-serif;
  --mono:     'JetBrains Mono', monospace;
  --r:        16px;
  --shadow:   0 8px 32px rgba(0,0,0,0.4);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { scroll-behavior: smooth; }

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* &#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;
   BACKGROUND EFFECTS
&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552; */
.bg-grid {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image:
    linear-gradient(rgba(0,229,255,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,229,255,0.025) 1px, transparent 1px);
  background-size: 48px 48px;
}

.bg-orb {
  position: fixed; border-radius: 50%; filter: blur(100px);
  pointer-events: none; z-index: 0;
}
.orb1 { width:700px;height:700px;top:-300px;right:-200px;background:radial-gradient(circle,rgba(0,229,255,0.07),transparent 70%); }
.orb2 { width:600px;height:600px;bottom:-200px;left:-150px;background:radial-gradient(circle,rgba(108,71,255,0.08),transparent 70%); }
.orb3 { width:400px;height:400px;top:40%;left:40%;background:radial-gradient(circle,rgba(0,255,163,0.04),transparent 70%); }

/* &#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;
   AUTH SCREEN
&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552; */
#auth-screen {
  position: relative; z-index: 10;
  min-height: 100vh;
  display: flex; align-items: center; justify-content: center;
  padding: 40px 20px;
}

.auth-wrap {
  width: 100%; max-width: 460px;
  display: flex; flex-direction: column; align-items: center; gap: 32px;
}

.auth-logo {
  text-align: center;
  animation: fadeDown 0.8s ease both;
}

.auth-logo-icon {
  width: 88px; height: 88px;
  border-radius: 26px;
  background: linear-gradient(135deg, var(--c1), var(--c2));
  display: inline-flex; align-items: center; justify-content: center;
  font-size: 40px;
  box-shadow: 0 0 0 1px rgba(0,229,255,0.3), 0 0 60px rgba(0,229,255,0.25), 0 20px 40px rgba(0,0,0,0.5);
  margin-bottom: 20px;
  position: relative;
}

.auth-logo-icon::after {
  content: '';
  position: absolute; inset: -1px;
  border-radius: 27px;
  background: linear-gradient(135deg, rgba(0,229,255,0.5), rgba(108,71,255,0.5));
  z-index: -1;
  filter: blur(8px);
}

.auth-logo h1 {
  font-size: 44px; font-weight: 900;
  letter-spacing: -2px; line-height: 1;
  background: linear-gradient(135deg, var(--c1) 0%, #a78bff 50%, var(--c2) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.auth-logo .tagline {
  font-size: 15px; color: var(--text2); margin-top: 10px; font-weight: 400;
}

.auth-card {
  width: 100%;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 28px;
  padding: 40px 36px;
  box-shadow: var(--shadow), 0 0 0 1px rgba(0,229,255,0.05);
  animation: fadeUp 0.8s 0.2s ease both;
}

.feature-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
  margin-bottom: 32px;
}

.feature-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  font-size: 13px; color: var(--text2); font-weight: 500;
  display: flex; align-items: center; gap: 8px;
  transition: border-color 0.2s, color 0.2s;
}
.feature-item:hover { border-color: var(--c1); color: var(--text); }
.feature-item .fi { font-size: 16px; }

.google-btn {
  width: 100%;
  background: white;
  border: none; border-radius: 14px;
  padding: 16px 24px;
  display: flex; align-items: center; justify-content: center; gap: 12px;
  font-family: var(--font); font-size: 16px; font-weight: 700; color: #1a1a2e;
  cursor: pointer;
  box-shadow: 0 4px 24px rgba(255,255,255,0.12);
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative; overflow: hidden;
}
.google-btn::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(66,133,244,0.08), rgba(52,168,83,0.08));
  opacity: 0; transition: opacity 0.2s;
}
.google-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 32px rgba(255,255,255,0.2);
}
.google-btn:hover::before { opacity: 1; }
.google-btn:active { transform: translateY(-1px); }

.google-logo { flex-shrink: 0; }

.divider {
  display: flex; align-items: center; gap: 12px;
  margin: 20px 0; color: var(--text3); font-size: 13px;
}
.divider::before, .divider::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

.demo-btn {
  width: 100%;
  background: transparent;
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 14px;
  font-family: var(--font); font-size: 14px; font-weight: 600;
  color: var(--text2); cursor: pointer;
  transition: all 0.2s;
}
.demo-btn:hover { border-color: var(--c3); color: var(--c3); }

.auth-note {
  font-size: 12px; color: var(--text3); text-align: center; margin-top: 16px;
  line-height: 1.6;
}

/* &#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;
   LOADING SCREEN
&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552; */
#loading-screen {
  position: fixed; inset: 0; z-index: 1000;
  background: var(--bg);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 28px;
}

.loader-visual {
  position: relative; width: 100px; height: 100px;
}

.loader-ring {
  position: absolute; inset: 0;
  border-radius: 50%;
  border: 2px solid transparent;
  animation: spin 1.2s linear infinite;
}
.loader-ring:nth-child(1) { border-top-color: var(--c1); }
.loader-ring:nth-child(2) { inset: 12px; border-top-color: var(--c2); animation-duration: 1.8s; animation-direction: reverse; }
.loader-ring:nth-child(3) { inset: 24px; border-top-color: var(--c3); animation-duration: 2.4s; }

.loader-center {
  position: absolute; inset: 34px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--c1), var(--c2));
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  box-shadow: 0 0 20px rgba(0,229,255,0.4);
}

#loading-screen h2 { font-size: 22px; font-weight: 700; }
#scan-status { color: var(--text2); font-family: var(--mono); font-size: 13px; }

.progress-wrap {
  width: 320px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  height: 6px; overflow: hidden;
}
.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--c1), var(--c2));
  border-radius: 8px;
  width: 0%;
  transition: width 0.4s ease;
  position: relative;
}
.progress-bar::after {
  content: '';
  position: absolute; right: 0; top: 0; bottom: 0;
  width: 40px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4));
  animation: shimmer 1s infinite;
}

#scan-count {
  font-family: var(--mono); font-size: 12px; color: var(--text3);
}

@keyframes shimmer { 0%,100%{opacity:0.5} 50%{opacity:1} }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeDown { from{opacity:0;transform:translateY(-20px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes slideIn { from{transform:translateX(-16px);opacity:0} to{transform:translateX(0);opacity:1} }
@keyframes countUp { from{opacity:0;transform:scale(0.8)} to{opacity:1;transform:scale(1)} }
@keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(0,229,255,0.3)} 50%{box-shadow:0 0 0 8px rgba(0,229,255,0)} }

/* &#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;
   DASHBOARD
&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552; */
#dashboard {
  position: relative; z-index: 10;
  min-height: 100vh;
  max-width: 1440px;
  margin: 0 auto;
  padding: 24px 20px 60px;
}

/* &#9472;&#9472; HEADER &#9472;&#9472; */
.dash-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 28px;
  flex-wrap: wrap; gap: 16px;
  animation: fadeDown 0.5s ease both;
}

.dash-brand {
  display: flex; align-items: center; gap: 14px;
}

.brand-icon {
  width: 48px; height: 48px; border-radius: 14px;
  background: linear-gradient(135deg, var(--c1), var(--c2));
  display: flex; align-items: center; justify-content: center;
  font-size: 22px;
  box-shadow: 0 0 20px rgba(0,229,255,0.25);
}

.brand-text h1 { font-size: 22px; font-weight: 900; letter-spacing: -0.5px; }
.brand-text span { font-size: 12px; color: var(--text2); }

.user-chip {
  display: flex; align-items: center; gap: 8px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 6px 14px 6px 6px;
  font-size: 13px;
}
.user-avatar {
  width: 28px; height: 28px; border-radius: 50%;
  background: linear-gradient(135deg, var(--c1), var(--c2));
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; color: var(--bg);
}

.header-actions { display: flex; gap: 8px; flex-wrap: wrap; }

.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 9px 16px;
  border-radius: 10px;
  font-family: var(--font); font-size: 13px; font-weight: 600;
  cursor: pointer; border: none;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-ghost {
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text2);
}
.btn-ghost:hover { border-color: var(--c1); color: var(--c1); }
.btn-primary-sm {
  background: linear-gradient(135deg, var(--c1), var(--c2));
  color: white;
}
.btn-primary-sm:hover { opacity: 0.88; transform: translateY(-1px); }

/* &#9472;&#9472; SUMMARY BAR &#9472;&#9472; */
.summary-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}

.stat-tile {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 20px;
  position: relative; overflow: hidden;
  transition: transform 0.2s, border-color 0.2s;
  animation: fadeUp 0.5s ease both;
}
.stat-tile:nth-child(1){animation-delay:0.05s}
.stat-tile:nth-child(2){animation-delay:0.1s}
.stat-tile:nth-child(3){animation-delay:0.15s}
.stat-tile:nth-child(4){animation-delay:0.2s}
.stat-tile:nth-child(5){animation-delay:0.25s}
.stat-tile:nth-child(6){animation-delay:0.3s}

.stat-tile::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  border-radius: var(--r) var(--r) 0 0;
}
.st-c1::before{background:var(--c1)}
.st-c2::before{background:var(--c2)}
.st-c3::before{background:var(--c3)}
.st-c4::before{background:var(--c4)}
.st-c5::before{background:var(--c5)}
.st-c6::before{background:var(--c6)}

.stat-tile:hover { transform: translateY(-3px); border-color: var(--border2); }

.stat-icon {
  font-size: 20px; margin-bottom: 10px;
  display: inline-block;
}

.stat-label {
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.8px; color: var(--text3); margin-bottom: 6px;
}

.stat-value {
  font-size: 26px; font-weight: 800;
  font-family: var(--mono); letter-spacing: -1px; line-height: 1;
}
.st-c1 .stat-value{color:var(--c1)}
.st-c2 .stat-value{color:var(--c2)}
.st-c3 .stat-value{color:var(--c3)}
.st-c4 .stat-value{color:var(--c4)}
.st-c5 .stat-value{color:var(--c5)}
.st-c6 .stat-value{color:var(--c6)}

.stat-sub { font-size: 11px; color: var(--text3); margin-top: 4px; }

.stat-trend {
  position: absolute; top: 16px; left: 16px;
  font-size: 11px; font-weight: 700; padding: 3px 7px;
  border-radius: 6px;
}
.trend-up { background: rgba(0,255,163,0.12); color: var(--c3); }
.trend-dn { background: rgba(255,77,109,0.12); color: var(--c6); }

/* &#9472;&#9472; MONTH STRIP &#9472;&#9472; */
.month-nav {
  margin-bottom: 24px;
  animation: fadeIn 0.5s 0.3s ease both;
}

.month-nav-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}

.section-title {
  font-size: 13px; font-weight: 700; color: var(--text2);
  text-transform: uppercase; letter-spacing: 0.8px;
}

.month-scroll {
  display: flex; gap: 8px; overflow-x: auto;
  padding-bottom: 4px;
  scrollbar-width: none;
}
.month-scroll::-webkit-scrollbar { display: none; }

.month-chip {
  flex-shrink: 0;
  padding: 10px 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--card);
  cursor: pointer;
  transition: all 0.2s;
  text-align: center; min-width: 90px;
}
.month-chip:hover { border-color: var(--border2); }
.month-chip.active {
  border-color: var(--c1);
  background: rgba(0,229,255,0.08);
}
.month-chip .mc-label {
  font-size: 12px; font-weight: 700; color: var(--text);
  display: block;
}
.month-chip .mc-amount {
  font-size: 11px; font-family: var(--mono);
  color: var(--text3); display: block; margin-top: 2px;
}
.month-chip.active .mc-label { color: var(--c1); }
.month-chip.active .mc-amount { color: var(--c1); opacity: 0.7; }

/* &#9472;&#9472; CHARTS ROW &#9472;&#9472; */
.charts-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
  animation: fadeUp 0.5s 0.35s ease both;
}

@media(max-width: 1100px) {
  .charts-row { grid-template-columns: 1fr 1fr; }
  .charts-row .chart-card:first-child { grid-column: 1 / -1; }
}
@media(max-width: 700px) {
  .charts-row { grid-template-columns: 1fr; }
  .charts-row .chart-card:first-child { grid-column: auto; }
}

.charts-row2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
  animation: fadeUp 0.5s 0.4s ease both;
}
@media(max-width: 700px) { .charts-row2 { grid-template-columns: 1fr; } }

.chart-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 24px;
  position: relative; overflow: hidden;
}

.chart-card::after {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at top right, rgba(0,229,255,0.03), transparent 60%);
  pointer-events: none;
}

.chart-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px;
}

.chart-title {
  font-size: 14px; font-weight: 700;
  display: flex; align-items: center; gap: 8px;
}

.chart-badge {
  font-size: 11px; font-weight: 700; padding: 3px 8px;
  border-radius: 6px; font-family: var(--mono);
  background: rgba(0,229,255,0.1); color: var(--c1);
}

/* Vendor bars */
.vendor-list { display: flex; flex-direction: column; gap: 14px; }
.vendor-item {}
.vendor-meta {
  display: flex; justify-content: space-between;
  margin-bottom: 6px;
}
.vendor-name { font-size: 13px; font-weight: 600; }
.vendor-amount { font-family: var(--mono); font-size: 13px; font-weight: 700; color: var(--c1); }
.vendor-track {
  height: 5px; background: var(--surface); border-radius: 4px; overflow: hidden;
}
.vendor-fill {
  height: 100%; border-radius: 4px;
  transition: width 1.2s cubic-bezier(0.34, 1.2, 0.64, 1);
}

/* Category donut legend */
.cat-legend {
  display: flex; flex-direction: column; gap: 8px;
  margin-top: 16px; overflow-y: auto; max-height: 200px;
}
.cat-legend::-webkit-scrollbar { width: 3px; }
.cat-legend::-webkit-scrollbar-track { background: var(--surface); }
.cat-legend::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

.cat-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 7px 10px; border-radius: 8px;
  cursor: pointer; transition: background 0.15s;
}
.cat-item:hover { background: var(--surface); }
.cat-left { display: flex; align-items: center; gap: 8px; }
.cat-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.cat-name { font-size: 12px; font-weight: 600; }
.cat-right { display: flex; gap: 12px; align-items: center; }
.cat-pct { font-family: var(--mono); font-size: 12px; color: var(--text3); }
.cat-val { font-family: var(--mono); font-size: 12px; font-weight: 700; color: var(--text); }

/* &#9472;&#9472; FILTERS &#9472;&#9472; */
.filters-panel {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px 20px;
  margin-bottom: 16px;
  display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
  animation: fadeUp 0.5s 0.45s ease both;
}

.filter-label {
  font-size: 12px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: 0.5px;
  white-space: nowrap;
}

.filter-input, .filter-select {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 9px 14px;
  color: var(--text);
  font-family: var(--font); font-size: 13px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  appearance: none;
}
.filter-input:focus, .filter-select:focus {
  border-color: var(--c1);
  box-shadow: 0 0 0 3px rgba(0,229,255,0.1);
}
.filter-select { cursor: pointer; padding-left: 32px; }
.filter-input { min-width: 220px; }
.select-wrap { position: relative; }
.select-wrap::after {
  content: '&#9660;';
  position: absolute; left: 10px; top: 50%;
  transform: translateY(-50%);
  font-size: 10px; color: var(--text3);
  pointer-events: none;
}
.filter-select option { background: var(--card); }

.filter-chips {
  display: flex; gap: 6px; flex-wrap: wrap; flex: 1;
}

.filter-chip {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  font-size: 12px; font-weight: 600; color: var(--text2);
  cursor: pointer; transition: all 0.15s;
  white-space: nowrap;
}
.filter-chip:hover { border-color: var(--border2); color: var(--text); }
.filter-chip.active { border-color: var(--c1); background: rgba(0,229,255,0.1); color: var(--c1); }

.results-count {
  font-family: var(--mono); font-size: 12px; color: var(--text3);
  white-space: nowrap; margin-right: auto;
}

/* &#9472;&#9472; TABLE &#9472;&#9472; */
.table-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--r);
  overflow: hidden;
  animation: fadeUp 0.5s 0.5s ease both;
}

.table-header {
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 12px;
}

.table-scroll { overflow-x: auto; }
.table-scroll::-webkit-scrollbar { height: 4px; }
.table-scroll::-webkit-scrollbar-track { background: var(--surface); }
.table-scroll::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

table { width: 100%; border-collapse: collapse; }

thead th {
  padding: 11px 16px;
  text-align: right;
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.6px; color: var(--text3);
  background: var(--surface);
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  transition: color 0.15s;
  position: relative;
}
thead th:hover { color: var(--c1); }
thead th .sort-icon { opacity: 0.4; margin-right: 4px; }
thead th.sorted { color: var(--c1); }
thead th.sorted .sort-icon { opacity: 1; }

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.12s;
}
tbody tr:hover { background: rgba(0,229,255,0.025); }
tbody tr:last-child { border-bottom: none; }

td {
  padding: 13px 16px;
  font-size: 13px;
  vertical-align: middle;
}

.td-sender {
  display: flex; align-items: center; gap: 10px;
}

.vendor-avatar {
  width: 34px; height: 34px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-weight: 700; flex-shrink: 0;
  font-family: var(--mono);
}

.sender-info .s-name { font-weight: 600; font-size: 13px; }
.sender-info .s-email { font-size: 11px; color: var(--text3); margin-top: 1px; }

.subject-cell { max-width: 280px; }
.subject-text {
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  font-size: 13px; color: var(--text2);
}

.amount-cell {
  font-family: var(--mono); font-weight: 700; font-size: 14px;
}
.amount-positive { color: var(--c3); }
.amount-none { color: var(--text3); font-size: 12px; }

.cat-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 20px;
  font-size: 11px; font-weight: 700; white-space: nowrap;
}

.date-cell { color: var(--text2); font-family: var(--mono); font-size: 12px; }

.open-btn {
  padding: 6px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text2);
  font-family: var(--font); font-size: 12px; font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  white-space: nowrap;
}
.open-btn:hover { border-color: var(--c1); color: var(--c1); }

/* &#9472;&#9472; PAGINATION &#9472;&#9472; */
.pagination {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 24px;
  border-top: 1px solid var(--border);
  flex-wrap: wrap; gap: 12px;
}
.page-info { font-size: 13px; color: var(--text3); font-family: var(--mono); }
.page-btns { display: flex; gap: 6px; }
.page-btn {
  width: 32px; height: 32px; border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text2); font-size: 13px; font-family: var(--mono);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.page-btn:hover, .page-btn.active {
  border-color: var(--c1); color: var(--c1);
  background: rgba(0,229,255,0.08);
}

/* &#9472;&#9472; TOAST &#9472;&#9472; */
.toasts {
  position: fixed; bottom: 24px; left: 24px; z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 18px;
  font-size: 13px;
  display: flex; align-items: center; gap: 10px;
  animation: slideIn 0.3s ease;
  max-width: 340px;
  box-shadow: var(--shadow);
}
.toast.success { border-color: var(--c3); }
.toast.error { border-color: var(--c6); }
.toast.info { border-color: var(--c1); }

/* &#9472;&#9472; EMPTY STATE &#9472;&#9472; */
.empty-state {
  padding: 60px 20px; text-align: center;
}
.empty-state p { color: var(--text3); font-size: 14px; margin-top: 12px; }

/* HIDDEN */
.hidden { display: none !important; }
</style>
</head>
<body>

<div class="bg-grid"></div>
<div class="bg-orb orb1"></div>
<div class="bg-orb orb2"></div>
<div class="bg-orb orb3"></div>

<!-- &#9552;&#9552;&#9552; AUTH &#9552;&#9552;&#9552; -->
<div id="auth-screen">
  <div class="auth-wrap">
    <div class="auth-logo">
      <div class="auth-logo-icon">&#128236;</div>
      <h1>InvoiceBox</h1>
      <p class="tagline">&#1505;&#1493;&#1512;&#1511; &#1495;&#1513;&#1489;&#1493;&#1504;&#1497;&#1493;&#1514; &#1495;&#1499;&#1501; &#1500;&#1490;&#39;&#1497;&#1502;&#1497;&#1497;&#1500; &#1513;&#1500;&#1498;</p>
    </div>

    <div class="auth-card">
      <div class="feature-grid">
        <div class="feature-item"><span class="fi">&#128202;</span> &#1490;&#1512;&#1508;&#1497;&#1501; &#1495;&#1493;&#1491;&#1513;&#1497;&#1497;&#1501;</div>
        <div class="feature-item"><span class="fi">&#127991;&#65039;</span> &#1511;&#1496;&#1490;&#1493;&#1512;&#1497;&#1494;&#1510;&#1497;&#1492; &#1488;&#1493;&#1496;&#1493;&#39;</div>
        <div class="feature-item"><span class="fi">&#128269;</span> &#1508;&#1497;&#1500;&#1496;&#1493;&#1512; &#1493;&#1495;&#1497;&#1508;&#1493;&#1513;</div>
        <div class="feature-item"><span class="fi">&#128229;</span> &#1497;&#1497;&#1510;&#1493;&#1488; CSV</div>
        <div class="feature-item"><span class="fi">&#128178;</span> &#1505;&#1499;&#1493;&#1502;&#1497;&#1501; &#1506;&#1500; &#1492;&#1513;&#1511;&#1500;</div>
        <div class="feature-item"><span class="fi">&#128336;</span> 24 &#1495;&#1493;&#1491;&#1513; &#1488;&#1495;&#1493;&#1512;&#1492;</div>
      </div>

      <button class="google-btn" onclick="startAuth()">
        <svg class="google-logo" width="22" height="22" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        &#1492;&#1514;&#1495;&#1489;&#1512; &#1506;&#1501; Google
      </button>

      <p class="auth-note">&#1511;&#1493;&#1512;&#1488; &#1502;&#1497;&#1497;&#1500;&#1497;&#1501; &#1489;&#1500;&#1489;&#1491; &#8212; &#1500;&#1488; &#1499;&#1493;&#1514;&#1489;, &#1500;&#1488; &#1502;&#1493;&#1495;&#1511;, &#1500;&#1488; &#1513;&#1493;&#1500;&#1495;</p>

      <div class="divider">&#1488;&#1493;</div>

      <button class="demo-btn" onclick="loadDemo()">&#128064; &#1492;&#1510;&#1490; &#1491;&#1502;&#1493; &#1489;&#1500;&#1497; &#1492;&#1514;&#1495;&#1489;&#1512;&#1493;&#1514;</button>
    </div>
  </div>
</div>

<!-- &#9552;&#9552;&#9552; LOADING &#9552;&#9552;&#9552; -->
<div id="loading-screen" class="hidden">
  <div class="loader-visual">
    <div class="loader-ring"></div>
    <div class="loader-ring"></div>
    <div class="loader-ring"></div>
    <div class="loader-center">&#9993;</div>
  </div>
  <h2>&#1505;&#1493;&#1512;&#1511; &#1495;&#1513;&#1489;&#1493;&#1504;&#1497;&#1493;&#1514;...</h2>
  <div id="scan-status">&#1502;&#1514;&#1495;&#1489;&#1512; &#1500;&#1490;&#39;&#1497;&#1502;&#1497;&#1497;&#1500;...</div>
  <div class="progress-wrap">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
  <div id="scan-count">0 &#1502;&#1497;&#1497;&#1500;&#1497;&#1501; &#1504;&#1505;&#1512;&#1511;&#1493;</div>
</div>

<!-- &#9552;&#9552;&#9552; DASHBOARD &#9552;&#9552;&#9552; -->
<div id="dashboard" class="hidden">

  <!-- HEADER -->
  <div class="dash-header">
    <div class="dash-brand">
      <div class="brand-icon">&#128236;</div>
      <div class="brand-text">
        <h1>InvoiceBox</h1>
        <span id="user-email">&#1502;&#1495;&#1493;&#1489;&#1512;</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-ghost" onclick="refreshScan()">&#8635; &#1505;&#1512;&#1493;&#1511; &#1502;&#1495;&#1491;&#1513;</button>
      <button class="btn btn-ghost" onclick="exportCSV()">&#128229; CSV</button>
      <button class="btn btn-ghost" onclick="logout()">&#128682; &#1492;&#1514;&#1504;&#1514;&#1511;</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="summary-bar" id="summary-bar"></div>

  <!-- MONTH NAV -->
  <div class="month-nav">
    <div class="month-nav-header">
      <span class="section-title">&#1505;&#1497;&#1504;&#1493;&#1503; &#1500;&#1508;&#1497; &#1495;&#1493;&#1491;&#1513;</span>
      <span id="active-period-label" style="font-size:12px;color:var(--text2)"></span>
    </div>
    <div class="month-scroll" id="month-scroll"></div>
  </div>

  <!-- CHARTS ROW 1 -->
  <div class="charts-row">
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">&#128202; &#1492;&#1493;&#1510;&#1488;&#1493;&#1514; &#1500;&#1508;&#1497; &#1495;&#1493;&#1491;&#1513;</div>
        <span class="chart-badge" id="chart-total-label">&#8203;</span>
      </div>
      <canvas id="monthly-chart" height="180"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">&#127383; &#1511;&#1496;&#1490;&#1493;&#1512;&#1497;&#1493;&#1514;</div>
      </div>
      <canvas id="category-chart" height="160"></canvas>
      <div class="cat-legend" id="cat-legend"></div>
    </div>
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">&#127959;&#65039; &#1505;&#1508;&#1511;&#1497;&#1501; &#1502;&#1493;&#1489;&#1497;&#1500;&#1497;&#1501;</div>
      </div>
      <div class="vendor-list" id="vendor-list"></div>
    </div>
  </div>

  <!-- CHARTS ROW 2 -->
  <div class="charts-row2">
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">&#128200; &#1502;&#1490;&#1502;&#1514; &#1492;&#1493;&#1510;&#1488;&#1493;&#1514;</div>
      </div>
      <canvas id="trend-chart" height="160"></canvas>
    </div>
    <div class="chart-card">
      <div class="chart-header">
        <div class="chart-title">&#128337; &#1492;&#1497;&#1505;&#1496;&#1493;&#1512;&#1497;&#1497;&#1514; &#1492;&#1493;&#1510;&#1488;&#1493;&#1514; &#1513;&#1489;&#1493;&#1506;&#1497;&#1514;</div>
      </div>
      <canvas id="heatmap-chart" height="160"></canvas>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters-panel">
    <span class="filter-label">&#1505;&#1504;&#1503;:</span>
    <input type="text" class="filter-input" id="search-input" placeholder="&#128269; &#1495;&#1508;&#1513; &#1513;&#1493;&#1500;&#1495;, &#1504;&#1493;&#1513;&#1488;, &#1505;&#1499;&#1493;&#1501;..." oninput="applyFilters()">
    <div class="select-wrap">
      <select class="filter-select" id="cat-filter" onchange="applyFilters()">
        <option value="">&#1499;&#1500; &#1511;&#1496;&#1490;&#1493;&#1512;&#1497;&#1493;&#1514;</option>
      </select>
    </div>
    <div class="select-wrap">
      <select class="filter-select" id="amount-filter" onchange="applyFilters()">
        <option value="">&#1499;&#1500; &#1505;&#1499;&#1493;&#1502;&#1493;&#1514;</option>
        <option value="0-50">&#8362;0 - &#8362;50</option>
        <option value="50-200">&#8362;50 - &#8362;200</option>
        <option value="200-500">&#8362;200 - &#8362;500</option>
        <option value="500-1000">&#8362;500 - &#8362;1,000</option>
        <option value="1000+">&#8362;1,000+</option>
      </select>
    </div>
    <div class="select-wrap">
      <select class="filter-select" id="sort-select" onchange="applyFilters()">
        <option value="date-desc">&#1514;&#1488;&#1512;&#1497;&#1498; &#8595;</option>
        <option value="date-asc">&#1514;&#1488;&#1512;&#1497;&#1498; &#8593;</option>
        <option value="amount-desc">&#1505;&#1499;&#1493;&#1501; &#8595;</option>
        <option value="amount-asc">&#1505;&#1499;&#1493;&#1501; &#8593;</option>
        <option value="sender">&#1513;&#1493;&#1500;&#1495;</option>
      </select>
    </div>
    <span class="results-count" id="results-count"></span>
  </div>

  <!-- TABLE -->
  <div class="table-card">
    <div class="table-header">
      <div class="chart-title">&#129534; &#1499;&#1500; &#1492;&#1495;&#1513;&#1489;&#1493;&#1504;&#1497;&#1493;&#1514;</div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('sender')"><span class="sort-icon">&#8597;</span>&#1513;&#1493;&#1500;&#1495;</th>
            <th onclick="sortBy('subject')"><span class="sort-icon">&#8597;</span>&#1504;&#1493;&#1513;&#1488;</th>
            <th onclick="sortBy('amount')"><span class="sort-icon">&#8597;</span>&#1505;&#1499;&#1493;&#1501;</th>
            <th onclick="sortBy('category')"><span class="sort-icon">&#8597;</span>&#1511;&#1496;&#1490;&#1493;&#1512;&#1497;&#1492;</th>
            <th onclick="sortBy('date')"><span class="sort-icon">&#8597;</span>&#1514;&#1488;&#1512;&#1497;&#1498;</th>
            <th>&#1508;&#1506;&#1493;&#1500;&#1493;&#1514;</th>
          </tr>
        </thead>
        <tbody id="invoice-tbody"></tbody>
      </table>
    </div>
    <div class="pagination">
      <span class="page-info" id="page-info"></span>
      <div class="page-btns" id="page-btns"></div>
    </div>
  </div>

</div>

<!-- TOASTS -->
<div class="toasts" id="toasts"></div>

<input type="number" id="months-back" value="24" style="display:none">

<script>
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// CONSTANTS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
const CLIENT_ID = '346127649716-mmtqoqa39p3pdm8k8ksp4k7phtp98a71.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest';
const PAGE_SIZE = 25;

const INVOICE_KEYWORDS = [
  'invoice','receipt','\u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05ea','\u05e7\u05d1\u05dc\u05d4',
  'order confirmation','your order','payment confirmation',
  '\u05d4\u05d6\u05de\u05e0\u05d4','\u05d0\u05d9\u05e9\u05d5\u05e8 \u05ea\u05e9\u05dc\u05d5\u05dd',
  'payment receipt','billing','\u05d7\u05d9\u05d5\u05d1','\u05ea\u05e9\u05dc\u05d5\u05dd',
  'subscription','\u05de\u05e0\u05d5\u05d9','purchase','transaction','\u05e2\u05e1\u05e7\u05d4',
  'paid','\u05e9\u05d5\u05dc\u05dd','thank you for your payment',
  '\u05ea\u05d5\u05d3\u05d4 \u05e2\u05dc \u05e8\u05db\u05d9\u05e9\u05ea\u05da',
  'order #','\u05d4\u05d6\u05de\u05e0\u05d4 \u05de\u05e1\u05e4\u05e8',
  'bill','\u05d7\u05e9\u05d1\u05d5\u05df','statement','tax invoice',
  '\u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05ea \u05de\u05e1'
];

const AMOUNT_PATTERNS = [
  /\u20aa\s*([\d,]+(?:\.\d{1,2})?)/g,
  /ILS\s*([\d,]+(?:\.\d{1,2})?)/gi,
  /\$\s*([\d,]+(?:\.\d{1,2})?)/g,
  /\u20ac\s*([\d,]+(?:\.\d{1,2})?)/g,
  /([\d,]+(?:\.\d{1,2})?)\s*\u20aa/g,
  /([\d,]+(?:\.\d{1,2})?)\s*ILS/gi,
  /total[:\s]+[\$\u20aa\u20ac]?\s*([\d,]+(?:\.\d{1,2})?)/gi,
  /\u05e1\u05d4"\u05db[:\s]+([\d,]+(?:\.\d{1,2})?)/g,
  /\u05e1\u05db\u05d5\u05dd[:\s]+([\d,]+(?:\.\d{1,2})?)/g,
  /amount[:\s]+[\$\u20aa\u20ac]?\s*([\d,]+(?:\.\d{1,2})?)/gi,
  /charged[:\s]+[\$\u20aa\u20ac]?\s*([\d,]+(?:\.\d{1,2})?)/gi,
  /\u05d7\u05d5\u05d9\u05d9\u05d1[:\s]+([\d,]+(?:\.\d{1,2})?)/g,
];

const CAT_MAP = {
  'amazon|ebay|aliexpress|wish':         { n:'\u05e7\u05e0\u05d9\u05d5\u05ea \u05d0\u05d5\u05e0\u05dc\u05d9\u05d9\u05df', i:'\ud83d\uded2', c:'#f59e0b' },
  'netflix|spotify|apple|google play|youtube|deezer|hbo|disney': { n:'\u05de\u05e0\u05d5\u05d9\u05d9\u05dd \u05d3\u05d9\u05d2\u05d9\u05d8\u05dc\u05d9\u05d9\u05dd', i:'\ud83d\udcf1', c:'#7c3aed' },
  'wolt|10bis|deliveroo|uber eats|pizza|burger': { n:'\u05d0\u05d5\u05db\u05dc \u05d5\u05de\u05e9\u05dc\u05d5\u05d7\u05d9\u05dd', i:'\ud83c\udf55', c:'#ef4444' },
  'cellcom|hot|partner|bezeq|yes|012|019|golan|pelephone': { n:'\u05ea\u05e7\u05e9\u05d5\u05e8\u05ea', i:'\ud83d\udce1', c:'#00d4ff' },
  'electric|electricity|\u05d7\u05e9\u05de\u05dc|\u05de\u05d9\u05dd|\u05d0\u05e8\u05e0\u05d5\u05e0\u05d4|\u05d2\u05d6': { n:'\u05d7\u05e9\u05d1\u05d5\u05e0\u05d5\u05ea \u05d1\u05d9\u05ea', i:'\ud83c\udfe0', c:'#10b981' },
  'flights|booking|airbnb|hotel|\u05d8\u05d9\u05e1\u05d5\u05ea|ryanair|easyjet|elal': { n:'\u05e0\u05e1\u05d9\u05e2\u05d5\u05ea', i:'\u2708\ufe0f', c:'#06b6d4' },
  'pharmacy|super pharm|\u05d1\u05d9\u05ea \u05de\u05e8\u05e7\u05d7\u05ea|boots|cvs': { n:'\u05d1\u05e8\u05d9\u05d0\u05d5\u05ea', i:'\ud83d\udc8a', c:'#84cc16' },
  'microsoft|adobe|dropbox|zoom|slack|notion|figma|github': { n:'\u05ea\u05d5\u05db\u05e0\u05d4', i:'\ud83d\udcbb', c:'#6366f1' },
  'insurance|\u05d1\u05d9\u05d8\u05d5\u05d7': { n:'\u05d1\u05d9\u05d8\u05d5\u05d7', i:'\ud83d\udee1\ufe0f', c:'#f97316' },
  'bank|\u05d1\u05e0\u05e7|visa|mastercard|paypal': { n:'\u05d1\u05e0\u05e7\u05d0\u05d5\u05ea', i:'\ud83c\udfe6', c:'#eab308' },
  'fuel|\u05d3\u05dc\u05e7|sonol|paz|delek|ten': { n:'\u05d3\u05dc\u05e7 \u05d5\u05e8\u05db\u05d1', i:'\u26fd', c:'#78716c' },
  'supermarket|shufersal|\u05e9\u05d5\u05e4\u05e8\u05e1\u05dc|rami levy|\u05e8\u05de\u05d9 \u05dc\u05d5\u05d9|mega|victory': { n:'\u05e1\u05d5\u05e4\u05e8 \u05de\u05e8\u05e7\u05d8', i:'\ud83d\uded1', c:'#4ade80' },
};

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// STATE
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
let invoices = [];
let filtered = [];
let currentPage = 1;
let currentSort = { field: 'date', dir: 'desc' };
let activeMonth = null;
let chartMonthly, chartCategory, chartTrend, chartHeatmap;

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// GOOGLE AUTH
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function loadScript(src) {
  return new Promise(r => { const s=document.createElement('script'); s.src=src; s.onload=r; document.head.appendChild(s); });
}

async function startAuth() {
  showScreen('loading');
  setStatus('\u05d8\u05d5\u05e2\u05df Google API...');
  try {
    await loadScript('https://apis.google.com/js/api.js');
    await new Promise(r => gapi.load('client', r));
    await loadScript('https://accounts.google.com/gsi/client');
    await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
    const tc = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID, scope: SCOPES,
      callback: async (res) => {
        if (res.error) { showScreen('auth'); toast('error', '\u274c \u05e9\u05d2\u05d9\u05d0\u05ea \u05d0\u05d9\u05de\u05d5\u05ea: ' + res.error); return; }
        await scanEmails();
      }
    });
    tc.requestAccessToken();
  } catch(e) { showScreen('auth'); toast('error', '\u274c \u05e9\u05d2\u05d9\u05d0\u05d4: ' + e.message); }
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// SCAN
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
async function scanEmails() {
  const monthsBack = parseInt(document.getElementById('months-back').value)||24;
  const after = new Date(); after.setMonth(after.getMonth()-monthsBack);
  const ts = Math.floor(after.getTime()/1000);

  const queries = [
    `after:${ts} subject:(invoice OR receipt OR \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05ea OR \u05e7\u05d1\u05dc\u05d4 OR "order confirmation" OR "payment confirmation" OR billing OR statement)`,
    `after:${ts} (invoice OR receipt OR billing) has:attachment`,
    `after:${ts} from:(billing OR payments OR invoices OR receipts OR noreply OR no-reply)`,
  ];

  let ids = new Set();
  for (const q of queries) {
    try {
      let pt = null;
      do {
        const p = { userId:'me', q, maxResults:500 };
        if (pt) p.pageToken = pt;
        const r = await gapi.client.gmail.users.messages.list(p);
        (r.result.messages||[]).forEach(m => ids.add(m.id));
        pt = r.result.nextPageToken;
        setStatus(`\u05e0\u05de\u05e6\u05d0\u05d5 ${ids.size} \u05d4\u05d5\u05d3\u05e2\u05d5\u05ea...`);
      } while (pt && ids.size < 2000);
    } catch(e){}
  }

  const idArr = [...ids];
  invoices = [];
  const BATCH = 25;
  for (let i=0; i<idArr.length; i+=BATCH) {
    const batch = idArr.slice(i, i+BATCH);
    const results = await Promise.all(batch.map(id =>
      gapi.client.gmail.users.messages.get({ userId:'me', id, format:'full', metadataHeaders:['From','Subject','Date'] })
        .then(r=>r.result).catch(()=>null)
    ));
    results.forEach(msg => { if(msg){ const inv=parseMessage(msg); if(inv) invoices.push(inv); }});
    const pct = Math.min(100, Math.round((i+BATCH)/idArr.length*100));
    document.getElementById('progress-bar').style.width = pct+'%';
    document.getElementById('scan-count').textContent = `${Math.min(i+BATCH,idArr.length)} / ${idArr.length} \u05de\u05d9\u05d9\u05dc\u05d9\u05dd | ${invoices.length} \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05d5\u05ea`;
    setStatus(`\u05e1\u05d5\u05e8\u05e7 ${Math.min(i+BATCH,idArr.length)} \u05d4\u05d5\u05d3\u05e2\u05d5\u05ea...`);
    await new Promise(r=>setTimeout(r,30));
  }

  try {
    const p = await gapi.client.gmail.users.getProfile({ userId:'me' });
    document.getElementById('user-email').textContent = p.result.emailAddress;
  } catch(e){}

  buildDashboard();
  showScreen('dashboard');
  toast('success', `\u2705 \u05e0\u05de\u05e6\u05d0\u05d5 ${invoices.length} \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05d5\u05ea!`);
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// PARSE MESSAGE
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function parseMessage(msg) {
  const hdrs = {}; (msg.payload?.headers||[]).forEach(h=>{ hdrs[h.name.toLowerCase()]=h.value; });
  const subject = hdrs['subject']||'';
  const from = hdrs['from']||'';
  const dateStr = hdrs['date']||'';
  const snippet = msg.snippet||'';
  const combined = (subject+' '+from+' '+snippet).toLowerCase();

  if (!INVOICE_KEYWORDS.some(k => combined.includes(k.toLowerCase()))) return null;

  let date = new Date(dateStr);
  if (isNaN(date)) date = new Date();

  const sm = from.match(/^"?([^"<]+)"?\s*</);
  const sender = sm ? sm[1].trim() : (from.split('@')[0]||from);

  // Amount: search subject + snippet
  let amount = null;
  const searchText = subject + ' ' + snippet;
  for (const pat of AMOUNT_PATTERNS) {
    pat.lastIndex = 0;
    let m;
    while ((m = pat.exec(searchText)) !== null) {
      const v = parseFloat(m[1].replace(/,/g,''));
      if (v > 1 && v < 999999) { amount = v; break; }
    }
    if (amount) break;
  }

  // Extract body text for better amount finding
  if (!amount && msg.payload) {
    const body = extractBody(msg.payload);
    if (body) {
      for (const pat of AMOUNT_PATTERNS) {
        pat.lastIndex = 0;
        let m;
        while ((m = pat.exec(body)) !== null) {
          const v = parseFloat(m[1].replace(/,/g,''));
          if (v > 1 && v < 999999) { amount = v; break; }
        }
        if (amount) break;
      }
    }
  }

  const cat = categorize(combined);
  return { id:msg.id, sender, from, subject, date, amount, category:cat.n, catIcon:cat.i, catColor:cat.c };
}

function extractBody(payload) {
  try {
    if (payload.body?.data) return atob(payload.body.data.replace(/-/g,'+').replace(/_/g,'/'));
    if (payload.parts) {
      for (const p of payload.parts) {
        const b = extractBody(p);
        if (b) return b;
      }
    }
  } catch(e){}
  return '';
}

function categorize(text) {
  for (const [pat, cat] of Object.entries(CAT_MAP)) {
    if (pat.split('|').some(p => text.includes(p))) return cat;
  }
  return { n:'\u05d0\u05d7\u05e8', i:'\ud83d\udcc4', c:'#64748b' };
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// DEMO
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function loadDemo() {
  showScreen('loading');
  setStatus('\u05d8\u05d5\u05e2\u05df \u05e0\u05ea\u05d5\u05e0\u05d9 \u05d3\u05de\u05d5...');
  document.getElementById('user-email').textContent = 'demo@gmail.com';

  const vendors = [
    { n:'Amazon', c:'\u05e7\u05e0\u05d9\u05d5\u05ea \u05d0\u05d5\u05e0\u05dc\u05d9\u05d9\u05df', i:'\ud83d\uded2', col:'#f59e0b', amounts:[49.9,129,299,89.9,199] },
    { n:'Netflix', c:'\u05de\u05e0\u05d5\u05d9\u05d9\u05dd \u05d3\u05d9\u05d2\u05d9\u05d8\u05dc\u05d9\u05d9\u05dd', i:'\ud83d\udcf1', col:'#7c3aed', amounts:[46.9,46.9,46.9] },
    { n:'Spotify', c:'\u05de\u05e0\u05d5\u05d9\u05d9\u05dd \u05d3\u05d9\u05d2\u05d9\u05d8\u05dc\u05d9\u05d9\u05dd', i:'\ud83d\udcf1', col:'#7c3aed', amounts:[24.9,24.9,24.9] },
    { n:'Wolt', c:'\u05d0\u05d5\u05db\u05dc \u05d5\u05de\u05e9\u05dc\u05d5\u05d7\u05d9\u05dd', i:'\ud83c\udf55', col:'#ef4444', amounts:[45,78,32,55,91,28] },
    { n:'Partner Mobile', c:'\u05ea\u05e7\u05e9\u05d5\u05e8\u05ea', i:'\ud83d\udce1', col:'#00d4ff', amounts:[149,149,149] },
    { n:'Hot', c:'\u05ea\u05e7\u05e9\u05d5\u05e8\u05ea', i:'\ud83d\udce1', col:'#00d4ff', amounts:[249,249,249] },
    { n:'Apple', c:'\u05de\u05e0\u05d5\u05d9\u05d9\u05dd \u05d3\u05d9\u05d2\u05d9\u05d8\u05dc\u05d9\u05d9\u05dd', i:'\ud83d\udcf1', col:'#7c3aed', amounts:[14.9,14.9,14.9] },
    { n:'AliExpress', c:'\u05e7\u05e0\u05d9\u05d5\u05ea \u05d0\u05d5\u05e0\u05dc\u05d9\u05d9\u05df', i:'\ud83d\uded2', col:'#f59e0b', amounts:[35,67,89,24] },
    { n:'Adobe CC', c:'\u05ea\u05d5\u05db\u05e0\u05d4', i:'\ud83d\udcbb', col:'#6366f1', amounts:[89,89,89] },
    { n:'Microsoft 365', c:'\u05ea\u05d5\u05db\u05e0\u05d4', i:'\ud83d\udcbb', col:'#6366f1', amounts:[45,45,45] },
    { n:'Booking.com', c:'\u05e0\u05e1\u05d9\u05e2\u05d5\u05ea', i:'\u2708\ufe0f', col:'#06b6d4', amounts:[890,1240,450] },
    { n:'Super-Pharm', c:'\u05d1\u05e8\u05d9\u05d0\u05d5\u05ea', i:'\ud83d\udc8a', col:'#84cc16', amounts:[89,145,67] },
    { n:'\u05d7\u05d1\u05e8\u05ea \u05d7\u05e9\u05de\u05dc', c:'\u05d7\u05e9\u05d1\u05d5\u05e0\u05d5\u05ea \u05d1\u05d9\u05ea', i:'\ud83c\udfe0', col:'#10b981', amounts:[310,290,340,280] },
    { n:'Shufersal', c:'\u05e1\u05d5\u05e4\u05e8 \u05de\u05e8\u05e7\u05d8', i:'\ud83d\uded1', col:'#4ade80', amounts:[450,380,520,410,490] },
    { n:'Ten Fuel', c:'\u05d3\u05dc\u05e7 \u05d5\u05e8\u05db\u05d1', i:'\u26fd', col:'#78716c', amounts:[200,180,220,195] },
    { n:'Dropbox', c:'\u05ea\u05d5\u05db\u05e0\u05d4', i:'\ud83d\udcbb', col:'#6366f1', amounts:[45,45,45] },
    { n:'PayPal', c:'\u05d1\u05e0\u05e7\u05d0\u05d5\u05ea', i:'\ud83c\udfe6', col:'#eab308', amounts:[50,120,80] },
    { n:'Airbnb', c:'\u05e0\u05e1\u05d9\u05e2\u05d5\u05ea', i:'\u2708\ufe0f', col:'#06b6d4', amounts:[700,450] },
    { n:'Google One', c:'\u05de\u05e0\u05d5\u05d9\u05d9\u05dd \u05d3\u05d9\u05d2\u05d9\u05d8\u05dc\u05d9\u05d9\u05dd', i:'\ud83d\udcf1', col:'#7c3aed', amounts:[9.9,9.9,9.9] },
    { n:'Rami Levy', c:'\u05e1\u05d5\u05e4\u05e8 \u05de\u05e8\u05e7\u05d8', i:'\ud83d\uded1', col:'#4ade80', amounts:[320,410,280,390] },
  ];

  invoices = [];
  const now = new Date();
  for (let m=23; m>=0; m--) {
    const numInv = Math.floor(Math.random()*18)+6;
    for (let i=0; i<numInv; i++) {
      const v = vendors[Math.floor(Math.random()*vendors.length)];
      const d = new Date(now.getFullYear(), now.getMonth()-m, Math.floor(Math.random()*27)+1);
      const amount = v.amounts[Math.floor(Math.random()*v.amounts.length)] + (Math.random()*5-2.5);
      invoices.push({
        id: `demo-${m}-${i}`,
        sender: v.n,
        from: `billing@${v.n.toLowerCase().replace(/\s+/g,'')}.com`,
        subject: `\u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05ea #${Math.floor(Math.random()*90000+10000)} - \u20aa${amount.toFixed(2)}`,
        date: d,
        amount: Math.round(amount*100)/100,
        category: v.c, catIcon: v.i, catColor: v.col
      });
    }
  }

  let p=0;
  const iv = setInterval(()=>{
    p+=3;
    document.getElementById('progress-bar').style.width=p+'%';
    document.getElementById('scan-count').textContent=`${Math.floor(p/100*invoices.length)} / ${invoices.length} \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05d5\u05ea`;
    if(p>=100){
      clearInterval(iv);
      setTimeout(()=>{ buildDashboard(); showScreen('dashboard'); toast('success',`\u2705 \u05d3\u05de\u05d5: ${invoices.length} \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05d5\u05ea`); }, 300);
    }
  },30);
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// DASHBOARD BUILD
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function buildDashboard() {
  invoices.sort((a,b)=>b.date-a.date);
  filtered = [...invoices];
  buildStats();
  buildMonthStrip();
  buildAllCharts();
  buildCatFilter();
  buildTable();
}

function buildStats() {
  const withAmt = invoices.filter(i=>i.amount);
  const total = withAmt.reduce((s,i)=>s+i.amount,0);
  const avg = withAmt.length ? total/withAmt.length : 0;
  const now = new Date();

  const thisM = invoices.filter(i=>i.date.getMonth()===now.getMonth()&&i.date.getFullYear()===now.getFullYear());
  const prevM = invoices.filter(i=>{const d=new Date(now);d.setMonth(d.getMonth()-1);return i.date.getMonth()===d.getMonth()&&i.date.getFullYear()===d.getFullYear();});
  const thisMAmt = thisM.filter(i=>i.amount).reduce((s,i)=>s+i.amount,0);
  const prevMAmt = prevM.filter(i=>i.amount).reduce((s,i)=>s+i.amount,0);
  const trend = prevMAmt>0 ? ((thisMAmt-prevMAmt)/prevMAmt*100).toFixed(1) : 0;

  const cats = {}; invoices.forEach(i=>{cats[i.category]=(cats[i.category]||0)+1;});
  const topCat = Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];

  const maxMonth = getMonthlyData().slice(-12).reduce((max,v)=>v>max?v:max,0);

  document.getElementById('summary-bar').innerHTML = `
    <div class="stat-tile st-c1">
      <div class="stat-label">\u05e1\u05d4"\u05db \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05d5\u05ea</div>
      <div class="stat-value">${n(invoices.length)}</div>
      <div class="stat-sub">\u05d1-${getMonthsRange()} \u05d7\u05d5\u05d3\u05e9\u05d9\u05dd</div>
    </div>
    <div class="stat-tile st-c3">
      <div class="stat-label">\u05e1\u05d4"\u05db \u05d4\u05d5\u05e6\u05d0\u05d5\u05ea</div>
      <div class="stat-value">\u20aa${n(total)}</div>
      <div class="stat-sub">${withAmt.length} \u05e2\u05dd \u05e1\u05db\u05d5\u05dd</div>
    </div>
    <div class="stat-tile st-c5">
      <div class="stat-label">\u05d4\u05d7\u05d5\u05d3\u05e9</div>
      <div class="stat-value">\u20aa${n(thisMAmt)}</div>
      <div class="stat-sub ${trend>0?'trend-up':'trend-dn'}" style="display:inline-block;padding:2px 6px;border-radius:5px;font-size:11px;font-weight:700;background:${trend>0?'rgba(255,77,109,0.12)':'rgba(0,255,163,0.12)'};color:${trend>0?'#ff4d6d':'#00ffa3'}">${trend>0?'\u25b2':'\u25bc'} ${Math.abs(trend)}%</div>
    </div>
    <div class="stat-tile st-c4">
      <div class="stat-label">\u05de\u05de\u05d5\u05e6\u05e2 \u05dc\u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05ea</div>
      <div class="stat-value">\u20aa${n(avg)}</div>
      <div class="stat-sub">\u05de\u05d1\u05d5\u05e1\u05e1 ${withAmt.length}</div>
    </div>
    <div class="stat-tile st-c2">
      <div class="stat-label">\u05e7\u05d8\u05d2 \u05de\u05d5\u05d1\u05d9\u05dc\u05d4</div>
      <div class="stat-value" style="font-size:16px">${topCat?topCat[0]:'-'}</div>
      <div class="stat-sub">${topCat?topCat[1]+' \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05d5\u05ea':''}</div>
    </div>
    <div class="stat-tile st-c6">
      <div class="stat-label">\u05e9\u05d9\u05d0 \u05d7\u05d5\u05d3\u05e9</div>
      <div class="stat-value">\u20aa${n(maxMonth)}</div>
      <div class="stat-sub">\u05d7\u05d5\u05d3\u05e9 \u05e9\u05d9\u05d0</div>
    </div>
  `;
}

function getMonthlyData() {
  const map = {};
  invoices.forEach(i=>{
    const k = `${i.date.getFullYear()}-${String(i.date.getMonth()+1).padStart(2,'0')}`;
    if(!map[k]) map[k]=0;
    if(i.amount) map[k]+=i.amount;
  });
  return Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])).map(([,v])=>Math.round(v));
}

function getMonthlyLabels() {
  const map = {};
  invoices.forEach(i=>{
    const k = `${i.date.getFullYear()}-${String(i.date.getMonth()+1).padStart(2,'0')}`;
    map[k]=1;
  });
  const mn = ['\u05d9\u05e0\u05d5','\u05e4\u05d1\u05e8','\u05de\u05e8\u05e5','\u05d0\u05e4\u05e8','\u05de\u05d0\u05d9','\u05d9\u05d5\u05e0\u05d9','\u05d9\u05d5\u05dc\u05d9','\u05d0\u05d5\u05d2','\u05e1\u05e4\u05d8','\u05d0\u05d5\u05e7','\u05e0\u05d5\u05d1','\u05d3\u05e6\u05de'];
  return Object.keys(map).sort().map(k=>{ const [y,m]=k.split('-'); return `${mn[parseInt(m)-1]} ${y.slice(2)}`; });
}

function getMonthsRange() {
  if(!invoices.length) return 0;
  const oldest = invoices.reduce((a,b)=>a.date<b.date?a:b);
  return Math.ceil((new Date()-oldest.date)/(30*24*3600*1000));
}

function buildMonthStrip() {
  const map = {};
  invoices.forEach(i=>{
    const k=`${i.date.getFullYear()}-${String(i.date.getMonth()+1).padStart(2,'0')}`;
    if(!map[k]) map[k]={count:0,amount:0};
    map[k].count++;
    if(i.amount) map[k].amount+=i.amount;
  });
  const sorted = Object.entries(map).sort((a,b)=>b[0].localeCompare(a[0]));
  const mn=['\u05d9\u05e0\u05d5','\u05e4\u05d1\u05e8','\u05de\u05e8\u05e5','\u05d0\u05e4\u05e8','\u05de\u05d0\u05d9','\u05d9\u05d5\u05e0\u05d9','\u05d9\u05d5\u05dc\u05d9','\u05d0\u05d5\u05d2','\u05e1\u05e4\u05d8','\u05d0\u05d5\u05e7','\u05e0\u05d5\u05d1','\u05d3\u05e6\u05de'];
  const strip = document.getElementById('month-scroll');
  strip.innerHTML = `<div class="month-chip active" onclick="filterMonth(null,this)">
    <span class="mc-label">\u05d4\u05db\u05dc</span>
    <span class="mc-amount">${invoices.length} \u05d7\u05e9\u05d1'</span>
  </div>`;
  sorted.forEach(([k,d])=>{
    const [y,m]=k.split('-');
    strip.innerHTML+=`<div class="month-chip" onclick="filterMonth('${k}',this)">
      <span class="mc-label">${mn[parseInt(m)-1]} ${y}</span>
      <span class="mc-amount">\u20aa${n(d.amount)}</span>
    </div>`;
  });
}

function filterMonth(key, el) {
  document.querySelectorAll('.month-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  activeMonth = key;
  const lbl = document.getElementById('active-period-label');
  lbl.textContent = key ? `\u05de\u05e6\u05d9\u05d2: ${el.querySelector('.mc-label').textContent}` : '';
  applyFilters();
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// CHARTS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
const chartDefaults = {
  responsive: true,
  plugins: { legend: { display: false } },
  scales: {
    x: { grid:{color:'rgba(29,46,74,0.6)'}, ticks:{color:'#4a6080',font:{size:10,family:"'Heebo'"}} },
    y: { grid:{color:'rgba(29,46,74,0.6)'}, ticks:{color:'#4a6080',font:{size:10,family:"'Heebo'"}, callback:v=>'\u20aa'+n(v)} }
  }
};

function buildAllCharts() {
  buildMonthlyChart();
  buildCategoryChart();
  buildVendorBars();
  buildTrendChart();
  buildHeatmap();
}

function buildMonthlyChart() {
  const labels = getMonthlyLabels();
  const data = getMonthlyData();
  const maxVal = Math.max(...data);

  if (chartMonthly) chartMonthly.destroy();
  chartMonthly = new Chart(document.getElementById('monthly-chart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: data.map(v => {
          const ratio = v/maxVal;
          return `rgba(0,229,255,${0.2+0.6*ratio})`;
        }),
        borderColor: data.map(v=>{
          const ratio = v/maxVal;
          return ratio > 0.8 ? '#00e5ff' : 'rgba(0,229,255,0.4)';
        }),
        borderWidth: 1,
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      ...chartDefaults,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ` \u20aa${n(ctx.raw)}`,
            title: ctx => ctx[0].label,
          },
          backgroundColor: '#162035',
          borderColor: '#1d2e4a',
          borderWidth: 1,
          titleColor: '#e8f0fe',
          bodyColor: '#00e5ff',
          padding: 10,
        }
      },
      scales: chartDefaults.scales,
      animation: { duration: 800, easing: 'easeOutQuart' }
    }
  });

  const total = data.reduce((s,v)=>s+v,0);
  document.getElementById('chart-total-label').textContent = `\u20aa${n(total)}`;
}

function buildCategoryChart() {
  const catTotals = {};
  invoices.forEach(i=>{ if(i.amount) catTotals[i.category]=(catTotals[i.category]||0)+i.amount; });
  const catColors = {};
  invoices.forEach(i=>{ catColors[i.category]=i.catColor; });
  const entries = Object.entries(catTotals).sort((a,b)=>b[1]-a[1]);
  const total = entries.reduce((s,[,v])=>s+v,0);

  if (chartCategory) chartCategory.destroy();
  chartCategory = new Chart(document.getElementById('category-chart'), {
    type: 'doughnut',
    data: {
      labels: entries.map(([k])=>k),
      datasets: [{ data: entries.map(([,v])=>Math.round(v)), backgroundColor: entries.map(([k])=>catColors[k]||'#64748b'), borderWidth: 0, hoverOffset: 6 }]
    },
    options: {
      responsive: true,
      cutout: '68%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: c=>`\u20aa${n(c.raw)} (${(c.raw/total*100).toFixed(1)}%)` },
          backgroundColor:'#162035', borderColor:'#1d2e4a', borderWidth:1,
          titleColor:'#e8f0fe', bodyColor:'#00e5ff', padding:10,
        }
      },
      animation: { duration: 800 }
    }
  });

  // Legend
  document.getElementById('cat-legend').innerHTML = entries.map(([k,v])=>`
    <div class="cat-item" onclick="filterByCategory('${k}')">
      <div class="cat-left">
        <div class="cat-dot" style="background:${catColors[k]||'#64748b'}"></div>
        <span class="cat-name">${k}</span>
      </div>
      <div class="cat-right">
        <span class="cat-pct">${(v/total*100).toFixed(1)}%</span>
        <span class="cat-val">\u20aa${n(v)}</span>
      </div>
    </div>
  `).join('');
}

function buildVendorBars() {
  const map = {};
  invoices.forEach(i=>{ if(i.amount) map[i.sender]=(map[i.sender]||0)+i.amount; });
  const top = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const max = top[0]?.[1]||1;
  const colors = ['#00e5ff','#6c47ff','#00ffa3','#ff6b35','#ffd93d','#ff4d6d','#a78bff','#34d399'];

  document.getElementById('vendor-list').innerHTML = top.map(([name,amt],i)=>`
    <div class="vendor-item">
      <div class="vendor-meta">
        <span class="vendor-name">${name}</span>
        <span class="vendor-amount">\u20aa${n(amt)}</span>
      </div>
      <div class="vendor-track">
        <div class="vendor-fill" style="width:${(amt/max*100).toFixed(1)}%;background:${colors[i%colors.length]};box-shadow:0 0 6px ${colors[i%colors.length]}55"></div>
      </div>
    </div>
  `).join('');
}

function buildTrendChart() {
  const labels = getMonthlyLabels();
  const data = getMonthlyData();
  const ma3 = data.map((v,i)=>{ const w=data.slice(Math.max(0,i-2),i+1); return Math.round(w.reduce((a,b)=>a+b,0)/w.length); });

  if (chartTrend) chartTrend.destroy();
  chartTrend = new Chart(document.getElementById('trend-chart'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: '\u05d4\u05d5\u05e6\u05d0\u05d5\u05ea',
          data,
          borderColor: 'rgba(0,229,255,0.7)',
          backgroundColor: 'rgba(0,229,255,0.05)',
          fill: true, tension: 0.4,
          pointRadius: 3, pointBackgroundColor: '#00e5ff',
          pointHoverRadius: 6,
        },
        {
          label: '\u05de\u05de\u05d5\u05e6\u05e2 \u05e0\u05e2 (3)',
          data: ma3,
          borderColor: 'rgba(108,71,255,0.9)',
          backgroundColor: 'transparent',
          borderDash: [5,4], tension: 0.4, pointRadius: 0,
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels:{color:'#8ba3c7',font:{size:11,family:"'Heebo'"},boxWidth:12,padding:12} },
        tooltip: {
          callbacks: { label: c=>`${c.dataset.label}: \u20aa${n(c.raw)}` },
          backgroundColor:'#162035', borderColor:'#1d2e4a', borderWidth:1, padding:10,
        }
      },
      scales: chartDefaults.scales,
      animation: { duration: 800 }
    }
  });
}

function buildHeatmap() {
  // Weekly spending heatmap using bar chart per day of week
  const days = ['\u05e8\u05d0\u05e9\u05d5\u05df','\u05e9\u05e0\u05d9','\u05e9\u05dc\u05d9\u05e9\u05d9','\u05e8\u05d1\u05d9\u05e2\u05d9','\u05d7\u05de\u05d9\u05e9\u05d9','\u05e9\u05d9\u05e9\u05d9','\u05e9\u05d1\u05ea'];
  const dayAmounts = [0,0,0,0,0,0,0];
  const dayCounts = [0,0,0,0,0,0,0];
  invoices.forEach(i=>{
    const d = i.date.getDay();
    dayCounts[d]++;
    if(i.amount) dayAmounts[d]+=i.amount;
  });

  if (chartHeatmap) chartHeatmap.destroy();
  chartHeatmap = new Chart(document.getElementById('heatmap-chart'), {
    type: 'bar',
    data: {
      labels: days,
      datasets: [
        {
          label: '\u05d4\u05d5\u05e6\u05d0\u05d5\u05ea',
          data: dayAmounts.map(v=>Math.round(v)),
          backgroundColor: dayAmounts.map((v,i)=>{
            const max = Math.max(...dayAmounts);
            const ratio = max>0?v/max:0;
            return `rgba(108,71,255,${0.2+0.7*ratio})`;
          }),
          borderColor: 'rgba(108,71,255,0.6)',
          borderWidth: 1, borderRadius: 6,
        }
      ]
    },
    options: {
      ...chartDefaults,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: { label: c=>`\u05d4\u05d5\u05e6\u05d0\u05d5\u05ea: \u20aa${n(c.raw)} | ${dayCounts[c.dataIndex]} \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05d5\u05ea` },
          backgroundColor:'#162035', borderColor:'#1d2e4a', borderWidth:1, padding:10,
        }
      },
      scales: chartDefaults.scales,
      animation: { duration: 800 }
    }
  });
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// FILTERS & TABLE
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function buildCatFilter() {
  const cats = [...new Set(invoices.map(i=>i.category))].sort();
  const sel = document.getElementById('cat-filter');
  sel.innerHTML = `<option value="">\u05db\u05dc \u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d5\u05ea</option>` +
    cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}

function filterByCategory(cat) {
  document.getElementById('cat-filter').value = cat;
  applyFilters();
  document.getElementById('invoice-tbody').scrollIntoView({ behavior:'smooth' });
}

function applyFilters() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const cat = document.getElementById('cat-filter').value;
  const amtRange = document.getElementById('amount-filter').value;
  const sort = document.getElementById('sort-select').value;

  let base = activeMonth ? invoices.filter(i=>{
    const [y,m]=activeMonth.split('-');
    return i.date.getFullYear()===parseInt(y)&&(i.date.getMonth()+1)===parseInt(m);
  }) : [...invoices];

  filtered = base.filter(i=>{
    const ms = !search || i.sender.toLowerCase().includes(search)||i.subject.toLowerCase().includes(search)||i.category.toLowerCase().includes(search)||(i.amount&&String(i.amount).includes(search));
    const mc = !cat || i.category===cat;
    let ma = true;
    if (amtRange) {
      const [lo,hi] = amtRange.split('-');
      if (hi==='undefined'||hi===undefined) { ma = i.amount && i.amount>=parseInt(lo); }
      else if (lo==='1000+') { ma = i.amount && i.amount>=1000; }
      else { ma = i.amount && i.amount>=parseInt(lo) && i.amount<=parseInt(hi); }
    }
    if (amtRange==='1000+') ma = i.amount && i.amount>=1000;
    return ms&&mc&&ma;
  });

  const [sf, sd] = sort.includes('-') ? sort.split('-') : [sort, 'asc'];
  filtered.sort((a,b)=>{
    let va, vb;
    if(sf==='date'){va=a.date;vb=b.date;}
    else if(sf==='amount'){va=a.amount||0;vb=b.amount||0;}
    else if(sf==='sender'){va=a.sender;vb=b.sender;}
    else if(sf==='category'){va=a.category;vb=b.category;}
    if(va<vb) return sd==='asc'?-1:1;
    if(va>vb) return sd==='asc'?1:-1;
    return 0;
  });

  currentPage = 1;
  document.getElementById('results-count').textContent = `${filtered.length} \u05ea\u05d5\u05e6\u05d0\u05d5\u05ea`;
  buildTable();
}

function sortBy(field) {
  const sel = document.getElementById('sort-select');
  const cur = sel.value;
  if(cur.startsWith(field)) { sel.value = cur.endsWith('desc') ? field+'-asc' : field+'-desc'; }
  else { sel.value = field+'-desc'; }
  // Update header indicators
  document.querySelectorAll('thead th').forEach(th=>{
    th.classList.remove('sorted');
    th.querySelector('.sort-icon').textContent='\u2195';
  });
  const thMap = {sender:0,subject:1,amount:2,category:3,date:4};
  const th = document.querySelectorAll('thead th')[thMap[field]];
  if(th){
    th.classList.add('sorted');
    th.querySelector('.sort-icon').textContent = sel.value.endsWith('asc')?'\u2191':'\u2193';
  }
  applyFilters();
}

function buildTable() {
  const start = (currentPage-1)*PAGE_SIZE;
  const page = filtered.slice(start, start+PAGE_SIZE);

  const colors = ['#00e5ff','#6c47ff','#00ffa3','#ff6b35','#ffd93d','#ff4d6d','#a78bff','#34d399','#fb7185','#38bdf8'];
  const ac = name => colors[([...name].reduce((s,c)=>s+c.charCodeAt(0),0)) % colors.length];

  if (!page.length) {
    document.getElementById('invoice-tbody').innerHTML = `
      <tr><td colspan="6">
        <div class="empty-state">
          <div style="font-size:40px">\ud83d\udd0d</div>
          <p>\u05dc\u05d0 \u05e0\u05de\u05e6\u05d0\u05d5 \u05ea\u05d5\u05e6\u05d0\u05d5\u05ea</p>
        </div>
      </td></tr>`;
    document.getElementById('page-info').textContent='';
    document.getElementById('page-btns').innerHTML='';
    return;
  }

  document.getElementById('invoice-tbody').innerHTML = page.map(inv => {
    const amtHTML = inv.amount
      ? `<span class="amount-positive">\u20aa${n(inv.amount)}</span>`
      : `<span class="amount-none">\u2014</span>`;
    const emailShort = inv.from.replace(/<.*>/,'').trim().substring(0,35);
    const subjShort = inv.subject.substring(0,55)+(inv.subject.length>55?'\u2026':'');
    const clr = ac(inv.sender);
    return `
    <tr>
      <td>
        <div class="td-sender">
          <div class="vendor-avatar" style="background:${clr}18;color:${clr}">${inv.catIcon||inv.sender[0]}</div>
          <div class="sender-info">
            <div class="s-name">${esc(inv.sender)}</div>
            <div class="s-email">${esc(emailShort)}</div>
          </div>
        </div>
      </td>
      <td class="subject-cell"><div class="subject-text" title="${esc(inv.subject)}">${esc(subjShort)}</div></td>
      <td class="amount-cell">${amtHTML}</td>
      <td><span class="cat-pill" style="background:${inv.catColor}18;color:${inv.catColor}">${inv.catIcon} ${esc(inv.category)}</span></td>
      <td class="date-cell">${fmtDate(inv.date)}</td>
      <td><button class="open-btn" onclick="openEmail('${inv.id}')">&#128231; \u05e4\u05ea\u05d7</button></td>
    </tr>`;
  }).join('');

  document.getElementById('page-info').textContent = `\u05de\u05e6\u05d9\u05d2 ${start+1}-${Math.min(start+PAGE_SIZE,filtered.length)} \u05de\u05ea\u05d5\u05da ${filtered.length}`;

  const totalPages = Math.ceil(filtered.length/PAGE_SIZE);
  let html='';
  if(currentPage>1) html+=`<button class="page-btn" onclick="goPage(${currentPage-1})">\u2039</button>`;
  const pages=[];
  for(let p=Math.max(1,currentPage-2);p<=Math.min(totalPages,currentPage+2);p++) pages.push(p);
  if(!pages.includes(1)){html+=`<button class="page-btn" onclick="goPage(1)">1</button>`;if(pages[0]>2)html+=`<span style="color:var(--text3);padding:0 4px;font-size:12px">...</span>`;}
  pages.forEach(p=>html+=`<button class="page-btn${p===currentPage?' active':''}" onclick="goPage(${p})">${p}</button>`);
  if(!pages.includes(totalPages)&&totalPages>1){if(pages[pages.length-1]<totalPages-1)html+=`<span style="color:var(--text3);padding:0 4px;font-size:12px">...</span>`;html+=`<button class="page-btn" onclick="goPage(${totalPages})">${totalPages}</button>`;}
  if(currentPage<totalPages) html+=`<button class="page-btn" onclick="goPage(${currentPage+1})">\u203a</button>`;
  document.getElementById('page-btns').innerHTML=html;
}

function goPage(p) { currentPage=p; buildTable(); window.scrollTo({top:document.getElementById('invoice-tbody').offsetTop-120,behavior:'smooth'}); }

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// EXPORT
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function exportCSV() {
  const BOM = '\uFEFF';
  const rows = [['\u05e9\u05d5\u05dc\u05d7','\u05d0\u05d9\u05de\u05d9\u05d9\u05dc','\u05e0\u05d5\u05e9\u05d0','\u05e1\u05db\u05d5\u05dd','\u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d4','\u05ea\u05d0\u05e8\u05d9\u05da']];
  filtered.forEach(i=>rows.push([i.sender,i.from,i.subject,i.amount?i.amount:'',i.category,fmtDate(i.date)]));
  const csv = BOM + rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
  a.download=`invoices_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  toast('success','\ud83d\udce5 CSV \u05d9\u05d5\u05e6\u05d0 \u05d1\u05d4\u05e6\u05dc\u05d7\u05d4!');
}

function openEmail(id) {
  if(id.startsWith('demo')) { toast('info','\u05d6\u05d4\u05d5 \u05e0\u05ea\u05d5\u05e0\u05d9 \u05d3\u05de\u05d5 - \u05d0\u05d9\u05df \u05de\u05d9\u05d9\u05dc \u05d0\u05de\u05d9\u05ea\u05d9'); return; }
  window.open(`https://mail.google.com/mail/u/0/#inbox/${id}`,'_blank');
}

async function refreshScan() {
  invoices=[];
  showScreen('loading');
  document.getElementById('progress-bar').style.width='0%';
  await scanEmails();
}

function logout() { invoices=[]; showScreen('auth'); }

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// UTILS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function showScreen(name) {
  ['auth-screen','loading-screen','dashboard'].forEach(id=>{
    document.getElementById(id).classList.toggle('hidden', !id.includes(name));
  });
}

function setStatus(msg) { document.getElementById('scan-status').textContent=msg; }

function n(v) {
  if(v===undefined||v===null||isNaN(v)) return '0';
  return Math.round(v).toLocaleString('he-IL');
}

function fmtDate(d) {
  if(!d||isNaN(d)) return '';
  return d.toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'2-digit'});
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function toast(type, msg) {
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.textContent=msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity 0.3s'; setTimeout(()=>el.remove(),300); },4000);
}

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// TESTS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function runTests() {
  const results = [];
  const pass = (name) => results.push({name, ok:true});
  const fail = (name, err) => results.push({name, ok:false, err});

  // Test 1: Amount extraction - ILS
  try {
    const msg = { payload:{headers:[{name:'From',value:'test@test.com'},{name:'Subject',value:'\u20aa149.90 - \u05d0\u05d9\u05e9\u05d5\u05e8 \u05ea\u05e9\u05dc\u05d5\u05dd'},{name:'Date',value:'Mon, 1 Jan 2024 10:00:00 +0200'}]}, snippet:'\u05e1\u05d4"\u05db \u20aa149.90' };
    const inv = parseMessage(msg);
    if (inv && inv.amount === 149.90) pass('\u05d7\u05d9\u05dc\u05d5\u05e5 \u05e1\u05db\u05d5\u05dd \u05e9\u05e7\u05dc\u05d9\u05dd (\u20aa)');
    else fail('\u05d7\u05d9\u05dc\u05d5\u05e5 \u05e1\u05db\u05d5\u05dd \u05e9\u05e7\u05dc\u05d9\u05dd (\u20aa)', `got ${inv?.amount}`);
  } catch(e) { fail('\u05d7\u05d9\u05dc\u05d5\u05e5 \u05e1\u05db\u05d5\u05dd \u05e9\u05e7\u05dc\u05d9\u05dd', e.message); }

  // Test 2: Invoice detection
  try {
    const msg1 = { payload:{headers:[{name:'From',value:'amazon@amazon.com'},{name:'Subject',value:'Your order confirmation #123'},{name:'Date',value:'Mon, 1 Jan 2024 10:00:00 +0200'}]}, snippet:'Thank you for your purchase' };
    const msg2 = { payload:{headers:[{name:'From',value:'friend@gmail.com'},{name:'Subject',value:'Hey how are you?'},{name:'Date',value:'Mon, 1 Jan 2024 10:00:00 +0200'}]}, snippet:'Just wanted to say hello' };
    if (parseMessage(msg1)) pass('\u2705 \u00a0\u05d4\u05db\u05e8\u05ea \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05ea \u05d0\u05de\u05d9\u05ea\u05d9\u05ea');
    else fail('\u05d4\u05db\u05e8\u05ea \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05ea \u05d0\u05de\u05d9\u05ea\u05d9\u05ea', 'should detect');
    if (!parseMessage(msg2)) pass('\u05d3\u05d7\u05d9\u05d9\u05ea \u05de\u05d9\u05d9\u05dc \u05e8\u05d2\u05d9\u05dc');
    else fail('\u05d3\u05d7\u05d9\u05d9\u05ea \u05de\u05d9\u05d9\u05dc \u05e8\u05d2\u05d9\u05dc', 'should not detect');
  } catch(e) { fail('\u05d4\u05db\u05e8\u05ea \u05d7\u05e9\u05d1\u05d5\u05e0\u05d9\u05d5\u05ea', e.message); }

  // Test 3: Categorization
  try {
    const c1 = categorize('amazon order confirmation');
    const c2 = categorize('netflix your subscription');
    const c3 = categorize('wolt \u05d4\u05d6\u05de\u05e0\u05ea\u05da');
    if (c1.n.includes('\u05e7\u05e0\u05d9\u05d5\u05ea')) pass('\u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d6\u05e6\u05d9\u05d4: Amazon');
    else fail('\u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d6\u05e6\u05d9\u05d4: Amazon', c1.n);
    if (c2.n.includes('\u05de\u05e0\u05d5\u05d9')) pass('\u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d6\u05e6\u05d9\u05d4: Netflix');
    else fail('\u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d6\u05e6\u05d9\u05d4: Netflix', c2.n);
    if (c3.n.includes('\u05d0\u05d5\u05db\u05dc')) pass('\u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d6\u05e6\u05d9\u05d4: Wolt');
    else fail('\u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d6\u05e6\u05d9\u05d4: Wolt', c3.n);
  } catch(e) { fail('\u05e7\u05d8\u05d2\u05d5\u05e8\u05d9\u05d6\u05e6\u05d9\u05d4', e.message); }

  // Test 4: Number formatting
  try {
    if (n(1234567) === '1,234,567') pass('\u05e4\u05d5\u05e8\u05de\u05d8 \u05de\u05e1\u05e4\u05e8\u05d9\u05dd');
    else fail('\u05e4\u05d5\u05e8\u05de\u05d8 \u05de\u05e1\u05e4\u05e8\u05d9\u05dd', n(1234567));
  } catch(e) { fail('\u05e4\u05d5\u05e8\u05de\u05d8 \u05de\u05e1\u05e4\u05e8\u05d9\u05dd', e.message); }

  // Test 5: Date formatting
  try {
    const d = new Date('2024-03-15');
    const fmt = fmtDate(d);
    if (fmt && fmt.includes('15') && fmt.includes('03')) pass('\u05e4\u05d5\u05e8\u05de\u05d8 \u05ea\u05d0\u05e8\u05d9\u05db\u05d9\u05dd');
    else fail('\u05e4\u05d5\u05e8\u05de\u05d8 \u05ea\u05d0\u05e8\u05d9\u05db\u05d9\u05dd', fmt);
  } catch(e) { fail('\u05e4\u05d5\u05e8\u05de\u05d8 \u05ea\u05d0\u05e8\u05d9\u05db\u05d9\u05dd', e.message); }

  // Test 6: Filter logic
  try {
    invoices = [
      {id:'1',sender:'Amazon',from:'a@a.com',subject:'Invoice',date:new Date(),amount:150,category:'\u05e7\u05e0\u05d9\u05d5\u05ea',catIcon:'\ud83d\uded2',catColor:'#f59e0b'},
      {id:'2',sender:'Netflix',from:'n@n.com',subject:'Subscription',date:new Date(),amount:47,category:'\u05de\u05e0\u05d5\u05d9',catIcon:'\ud83d\udcf1',catColor:'#7c3aed'},
      {id:'3',sender:'Wolt',from:'w@w.com',subject:'Order',date:new Date(),amount:null,category:'\u05d0\u05d5\u05db\u05dc',catIcon:'\ud83c\udf55',catColor:'#ef4444'},
    ];
    filtered = [...invoices];
    document.getElementById('search-input').value='amazon';
    document.getElementById('cat-filter').value='';
    document.getElementById('amount-filter').value='';
    document.getElementById('sort-select').value='date-desc';
    applyFilters();
    if(filtered.length===1&&filtered[0].sender==='Amazon') pass('\u05e1\u05d9\u05e0\u05d5\u05df \u05dc\u05e4\u05d9 \u05e9\u05dd');
    else fail('\u05e1\u05d9\u05e0\u05d5\u05df \u05dc\u05e4\u05d9 \u05e9\u05dd', `got ${filtered.length}`);
    document.getElementById('search-input').value='';
    document.getElementById('amount-filter').value='50-200';
    applyFilters();
    if(filtered.length===1&&filtered[0].amount===150) pass('\u05e1\u05d9\u05e0\u05d5\u05df \u05dc\u05e4\u05d9 \u05d8\u05d5\u05d5\u05d7 \u05e1\u05db\u05d5\u05de\u05d5\u05ea');
    else fail('\u05e1\u05d9\u05e0\u05d5\u05df \u05dc\u05e4\u05d9 \u05d8\u05d5\u05d5\u05d7 \u05e1\u05db\u05d5\u05de\u05d5\u05ea', `got ${filtered.length}`);
    invoices=[];filtered=[];
    document.getElementById('search-input').value='';
    document.getElementById('amount-filter').value='';
  } catch(e) { fail('\u05dc\u05d5\u05d2\u05d9\u05e7\u05ea \u05e1\u05d9\u05e0\u05d5\u05df', e.message); }

  // Test 7: Sorting
  try {
    invoices=[
      {id:'1',sender:'B',from:'',subject:'',date:new Date('2024-01-01'),amount:100,category:'\u05d0\u05d7\u05e8',catIcon:'',catColor:''},
      {id:'2',sender:'A',from:'',subject:'',date:new Date('2024-03-01'),amount:200,category:'\u05d0\u05d7\u05e8',catIcon:'',catColor:''},
    ];
    filtered=[...invoices];
    document.getElementById('sort-select').value='amount-desc';
    document.getElementById('search-input').value='';
    document.getElementById('cat-filter').value='';
    document.getElementById('amount-filter').value='';
    applyFilters();
    if(filtered[0].amount===200&&filtered[1].amount===100) pass('\u05de\u05d9\u05d5\u05df \u05dc\u05e4\u05d9 \u05e1\u05db\u05d5\u05dd');
    else fail('\u05de\u05d9\u05d5\u05df \u05dc\u05e4\u05d9 \u05e1\u05db\u05d5\u05dd', `${filtered[0].amount},${filtered[1].amount}`);
    invoices=[];filtered=[];
  } catch(e) { fail('\u05de\u05d9\u05d5\u05df', e.message); }

  // Print results
  const passed = results.filter(r=>r.ok).length;
  console.log(`\n\u2554${'\u2550'.repeat(50)}\u2557`);
  console.log(`\u2551 InvoiceBox Tests: ${passed}/${results.length} \u05e2\u05d1\u05e8\u05d5 \u2551`);
  console.log(`\u255a${'\u2550'.repeat(50)}\u255d`);
  results.forEach(r=>{
    if(r.ok) console.log(`  \u2705 ${r.name}`);
    else console.error(`  \u274c ${r.name}: ${r.err}`);
  });

  if(passed===results.length) toast('success', `\u2705 \u05db\u05dc ${results.length} \u05d4\u05d8\u05e1\u05d8\u05d9\u05dd \u05e2\u05d1\u05e8\u05d5!`);
  else toast('error', `\u274c ${results.length-passed} \u05d8\u05e1\u05d8\u05d9\u05dd \u05e0\u05db\u05e9\u05dc\u05d5`);

  return results;
}

// Run tests on load
setTimeout(runTests, 500);
</script>
</body>
</html>
